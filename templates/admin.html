<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - RAG Chatbot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .card {
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            background-color: #f8f9fa;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.875rem;
            font-weight: 500;
        }
        .status-success {
            background-color: #d4edda;
            color: #155724;
        }
        .status-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .btn-upload {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        .btn-upload:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            color: white;
        }
        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #667eea;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="admin-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col">
                    <h1><i class="fas fa-cogs"></i> Admin Panel</h1>
                    <p class="mb-0">Manage documents and configure the RAG chatbot</p>
                </div>
                <div class="col-auto">
                    <a href="{{ url_for('chatbot') }}" class="btn btn-light">
                        <i class="fas fa-comments"></i> Go to Chatbot
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        <i class="fas fa-info-circle"></i> {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <!-- Logo Upload Section -->
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-image"></i> Chatbot Logo
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <form action="{{ url_for('upload_logo') }}" method="post" enctype="multipart/form-data">
                                    <div class="mb-3">
                                        <label for="logoFile" class="form-label">Upload Logo</label>
                                        <input type="file" class="form-control" id="logoFile" name="logo" accept=".png,.jpg,.jpeg,.gif,.svg" required>
                                        <div class="form-text">Accepted formats: PNG, JPG, JPEG, GIF, SVG (Max 5MB)</div>
                                    </div>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-upload"></i> Upload Logo
                                    </button>
                                </form>
                            </div>
                            <div class="col-md-4">
                                {% if current_logo %}
                                    <div class="text-center">
                                        <p class="mb-2"><strong>Current Logo:</strong></p>
                                        <img src="{{ current_logo }}" 
                                             alt="Current Logo" 
                                             class="img-fluid border rounded" 
                                             style="max-height: 100px;">
                                    </div>
                                {% else %}
                                    <div class="text-center text-muted">
                                        <i class="fas fa-image fa-3x mb-2"></i>
                                        <p>No logo uploaded</p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        

        <div class="row">
            <!-- Upload Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-cloud-upload-alt"></i> Upload Documents
                    </div>
                    <div class="card-body">
                        <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data">
                            <div class="upload-area">
                                <i class="fas fa-file-upload fa-3x text-muted mb-3"></i>
                                <div class="mb-3">
                                    <input type="file" class="form-control" name="file" accept=".pdf,.docx" required>
                                </div>
                                <p class="text-muted">Upload PDF or DOCX files</p>
                                <button type="submit" class="btn btn-upload">
                                    <i class="fas fa-upload"></i> Upload File
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Vectorization Section -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-brain"></i> Vector Database
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span>Status:</span>
                            {% if index_exists %}
                                <span class="status-badge status-success">
                                    <i class="fas fa-check"></i> Ready
                                </span>
                            {% else %}
                                <span class="status-badge status-warning">
                                    <i class="fas fa-exclamation-triangle"></i> Not Built
                                </span>
                            {% endif %}
                        </div>
                        
                        <p class="text-muted mb-3">
                            Vectorize uploaded documents to enable semantic search and question answering.
                        </p>
                        
                        <div class="d-grid gap-2">
                            <form action="{{ url_for('vectorize') }}" method="post" style="display: inline;">
                                <button type="submit" class="btn btn-success w-100" 
                                        {% if not uploaded_files %}disabled{% endif %}>
                                    <i class="fas fa-cogs"></i> Vectorize Documents
                                </button>
                            </form>
                            
                            {% if index_exists %}
                                <form action="{{ url_for('clear_index') }}" method="post" style="display: inline;">
                                    <button type="submit" class="btn btn-outline-danger w-100" 
                                            onclick="return confirm('Are you sure you want to clear the vector index?')">
                                        <i class="fas fa-trash"></i> Clear Index
                                    </button>
                                </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Uploaded Files Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-files"></i> Uploaded Files ({{ uploaded_files|length }})
                    </div>
                    <div class="card-body">
                        {% if uploaded_files %}
                            {% for file in uploaded_files %}
                                <div class="file-item">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-file-{% if file.endswith('.pdf') %}pdf{% else %}word{% endif %} text-primary me-2"></i>
                                        <span>{{ file }}</span>
                                    </div>
                                    <form action="{{ url_for('delete_file', filename=file) }}" method="post" style="display: inline;">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" 
                                                onclick="return confirm('Are you sure you want to delete this file?')">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-folder-open fa-3x mb-3"></i>
                                <p>No files uploaded yet. Upload some documents to get started!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- ElevenLabs Configuration Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-microphone"></i> ElevenLabs Voice Configuration
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <p class="text-muted mb-3">
                                    Configure ElevenLabs API key for premium voice synthesis. The üé§ button in the chat widget uses ElevenLabs for high-quality voice responses.
                                </p>
                                
                                <form action="{{ url_for('update_elevenlabs_key') }}" method="post" class="mb-3">
                                    <div class="row align-items-end">
                                        <div class="col-md-8">
                                            <label for="elevenlabs_key" class="form-label">ElevenLabs API Key</label>
                                            <input type="password" class="form-control" id="elevenlabs_key" name="elevenlabs_key" 
                                                   placeholder="Enter your ElevenLabs API key" required>
                                            <div class="form-text">
                                                Get your API key from <a href="https://elevenlabs.io" target="_blank">elevenlabs.io</a>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <button type="submit" class="btn btn-primary w-100">
                                                <i class="fas fa-save"></i> Save Key
                                            </button>
                                        </div>
                                    </div>
                                </form>
                                
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <span>API Key Status:</span>
                                    <span class="status-badge" id="elevenlabs-status">
                                        <i class="fas fa-circle" id="elevenlabs-icon"></i> <span id="elevenlabs-text">Checking...</span>
                                    </span>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="bg-light p-3 rounded">
                                    <h6><i class="fas fa-info-circle text-info"></i> Voice Comparison</h6>
                                    <div class="mb-2">
                                        <strong>üéôÔ∏è Regular Voice:</strong><br>
                                        <small class="text-muted">Google TTS + Kokoro (Free)</small>
                                    </div>
                                    <div class="mb-2">
                                        <strong>üé§ ElevenLabs Voice:</strong><br>
                                        <small class="text-muted">Premium AI voices (Paid)</small>
                                    </div>
                                    <hr>
                                    <div class="d-flex justify-content-between">
                                        <a href="{{ url_for('static', filename='../test_elevenlabs_voice.html') }}" 
                                           class="btn btn-sm btn-outline-primary" target="_blank">
                                            <i class="fas fa-play"></i> Test
                                        </a>
                                        <button class="btn btn-sm btn-outline-info" onclick="checkElevenLabsStatus()">
                                            <i class="fas fa-sync"></i> Check
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Unified Conversations Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-comments"></i> All Conversations
                        <small class="text-muted">(Chatbot + Live Chat)</small>
                        <div class="float-end">
                            <button class="btn btn-sm btn-outline-info" onclick="loadConversationStats()">
                                <i class="fas fa-chart-bar"></i> Stats
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshConversations()">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Stats Row -->
                        <div class="row mb-3" id="conversationStatsRow" style="display: none;">
                            <div class="col-md-12">
                                <div class="alert alert-info" id="conversationStats">
                                    <!-- Stats will be loaded here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <label for="conversationTypeFilter" class="form-label">Type:</label>
                                <select class="form-select" id="conversationTypeFilter" onchange="filterConversations()">
                                    <option value="all">All Conversations</option>
                                    <option value="chatbot">Chatbot Only</option>
                                    <option value="live_chat">Live Chat Only</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="userFilter" class="form-label">Filter by User:</label>
                                <select class="form-select" id="userFilter" onchange="filterConversations()">
                                    <option value="">All Users</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="dateFilter" class="form-label">Date Range:</label>
                                <select class="form-select" id="dateFilter" onchange="filterConversations()">
                                    <option value="">All Time</option>
                                    <option value="today">Today</option>
                                    <option value="week">This Week</option>
                                    <option value="month">This Month</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="searchConversations" class="form-label">Search:</label>
                                <input type="text" class="form-control" id="searchConversations" 
                                       placeholder="Search conversations..." onkeyup="searchConversations()">
                            </div>
                        </div>
                        
                        <div id="conversationsContainer">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                                <p class="mt-2 text-muted">Loading conversations...</p>
                            </div>
                        </div>
                        
                        <!-- Pagination -->
                        <div class="d-flex justify-content-between align-items-center mt-3" id="conversationPagination" style="display: none;">
                            <div>
                                <small class="text-muted" id="conversationCount">Showing 0 conversations</small>
                            </div>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-secondary" id="prevPageBtn" onclick="previousPage()" disabled>
                                    <i class="fas fa-chevron-left"></i> Previous
                                </button>
                                <button class="btn btn-outline-secondary" id="nextPageBtn" onclick="nextPage()" disabled>
                                    Next <i class="fas fa-chevron-right"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Widget Integration Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-code"></i> Widget Integration
                        <div class="float-end">
                            <a href="{{ url_for('widget_demo') }}" class="btn btn-sm btn-outline-primary" target="_blank">
                                <i class="fas fa-external-link-alt"></i> Live Demo
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-rocket"></i> Quick Integration</h6>
                                <p class="text-muted">Add this script to your website's HTML head section or before closing &lt;/body&gt; tag:</p>
                                <div class="position-relative">
                                    <pre class="bg-light p-3 rounded" style="font-size: 0.9rem; max-height: 200px; overflow-y: auto;"><code id="basicWidgetScript">&lt;!-- Add to &lt;head&gt; section or before &lt;/body&gt; --&gt;
&lt;script src="{{ request.url_root }}static/chatwidget.js"&gt;&lt;/script&gt;
&lt;script&gt;
    ChatWidget.init({
        apiUrl: '{{ request.url_root.rstrip('/') }}',
        user_id: 'your_user_id',
        username: 'User Name',
        email: 'user@example.com',
        device_id: 'web_browser',
        position: 'bottom-right',
        title: 'AI Assistant',
        persistentHistoryCount: 10  // Number of messages to persist
    });
&lt;/script&gt;</code></pre>
                                    <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" 
                                            onclick="copyToClipboard('basicWidgetScript')" title="Copy to clipboard">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-cogs"></i> Configuration Options</h6>
                                <div class="table-responsive">
                                    <table class="table table-sm">
                                        <thead>
                                            <tr>
                                                <th>Parameter</th>
                                                <th>Description</th>
                                                <th>Required</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><code>apiUrl</code></td>
                                                <td>Your chatbot API endpoint</td>
                                                <td><span class="badge bg-danger">Yes</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>user_id</code></td>
                                                <td>Unique user identifier</td>
                                                <td><span class="badge bg-warning">Optional</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>username</code></td>
                                                <td>Display name for user</td>
                                                <td><span class="badge bg-warning">Optional</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>email</code></td>
                                                <td>User's email address</td>
                                                <td><span class="badge bg-warning">Optional</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>device_id</code></td>
                                                <td>Device identifier</td>
                                                <td><span class="badge bg-warning">Optional</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>persistentHistoryCount</code></td>
                                                <td>Number of messages to persist across sessions (default: 10)</td>
                                                <td><span class="badge bg-warning">Optional</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>position</code></td>
                                                <td>bottom-right, bottom-left</td>
                                                <td><span class="badge bg-warning">Optional</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>title</code></td>
                                                <td>Widget title in header</td>
                                                <td><span class="badge bg-warning">Optional</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>apiKey</code></td>
                                                <td>API authentication key</td>
                                                <td><span class="badge bg-warning">Optional</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>allowedDomains</code></td>
                                                <td>Array of allowed domains</td>
                                                <td><span class="badge bg-warning">Optional</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>iconUrl</code></td>
                                                <td>Custom icon URL for chat widget</td>
                                                <td><span class="badge bg-warning">Optional</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>widgetSize</code></td>
                                                <td>Widget window size: 'small', 'medium', 'large'</td>
                                                <td><span class="badge bg-warning">Optional</span></td>
                                            </tr>
                                            <tr>
                                                <td><code>buttonSize</code></td>
                                                <td>Toggle button size in pixels (default: 60)</td>
                                                <td><span class="badge bg-warning">Optional</span></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        

                        
                        <!-- Widget Icon Customization -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-paint-brush"></i> Widget Icon Customization
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-upload"></i> Upload Custom Icon</h6>
                                                <p class="text-muted">Upload a custom icon for your chat widget. Supports PNG, JPG, SVG formats.</p>
                                                <form id="iconUploadForm" enctype="multipart/form-data">
                                                    <div class="input-group mb-3">
                                                        <input type="file" class="form-control" id="iconFile" name="iconFile" accept="image/*">
                                                        <button class="btn btn-outline-primary" type="submit">
                                                            <i class="fas fa-upload"></i> Upload Icon
                                                        </button>
                                                    </div>
                                                </form>
                                                <div id="iconUploadStatus" class="mt-2"></div>
                                            </div>
                                            <div class="col-md-6">
                                                <h6><i class="fas fa-eye"></i> Current Icon</h6>
                                                <div id="currentIcon" class="text-center p-3 border rounded">
                                                    <i class="fas fa-comments fa-3x text-primary"></i>
                                                    <p class="text-muted mt-2">Default Chat Icon</p>
                                                </div>
                                                <div class="mt-3">
                                                    <button class="btn btn-sm btn-outline-secondary me-2" onclick="resetToDefaultIcon()">
                                                        <i class="fas fa-undo"></i> Reset to Default
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-info" onclick="previewIcon()">
                                                        <i class="fas fa-eye"></i> Preview
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="row">
                            <div class="col-12">
                                <h6><i class="fas fa-magic"></i> Advanced Integration Examples</h6>
                                <div class="accordion" id="integrationExamples">
                                    <!-- Anonymous User Example -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="anonymousHeading">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#anonymousExample">
                                                <i class="fas fa-user-slash me-2"></i> Anonymous Users (No Login Required)
                                            </button>
                                        </h2>
                                        <div id="anonymousExample" class="accordion-collapse collapse" data-bs-parent="#integrationExamples">
                                            <div class="accordion-body">
                                                <p>For websites where users don't need to log in:</p>
                                                <div class="position-relative">
                                                    <pre class="bg-light p-3 rounded" style="font-size: 0.9rem;"><code id="anonymousScript">&lt;script src="{{ request.url_root }}static/chatwidget.js"&gt;&lt;/script&gt;
&lt;script&gt;
    ChatWidget.init({
        apiUrl: '{{ request.url_root.rstrip('/') }}',
        position: 'bottom-right',
        title: 'Help Assistant'
    });
&lt;/script&gt;</code></pre>
                                                    <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" 
                                                            onclick="copyToClipboard('anonymousScript')">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Dynamic User Example -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="dynamicHeading">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dynamicExample">
                                                <i class="fas fa-sync-alt me-2"></i> Dynamic User Configuration
                                            </button>
                                        </h2>
                                        <div id="dynamicExample" class="accordion-collapse collapse" data-bs-parent="#integrationExamples">
                                            <div class="accordion-body">
                                                <p>For websites with user authentication - update configuration after login:</p>
                                                <div class="position-relative">
                                                    <pre class="bg-light p-3 rounded" style="font-size: 0.9rem;"><code id="dynamicScript">&lt;script src="{{ request.url_root }}static/chatwidget.js"&gt;&lt;/script&gt;
&lt;script&gt;
    // Initialize as anonymous
    ChatWidget.init({
        apiUrl: '{{ request.url_root.rstrip('/') }}',
        position: 'bottom-right'
    });
    
    // Update after user logs in
    function onUserLogin(user) {
        ChatWidget.updateConfig({
            user_id: user.id,
            username: user.name,
            email: user.email,
            device_id: 'web_app',
            persistentHistoryCount: 15  // Keep last 15 messages
        });
    }
&lt;/script&gt;</code></pre>
                                                    <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" 
                                                            onclick="copyToClipboard('dynamicScript')">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- E-commerce Example -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="ecommerceHeading">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#ecommerceExample">
                                                <i class="fas fa-shopping-cart me-2"></i> E-commerce Integration
                                            </button>
                                        </h2>
                                        <div id="ecommerceExample" class="accordion-collapse collapse" data-bs-parent="#integrationExamples">
                                            <div class="accordion-body">
                                                <p>For online stores with customer support:</p>
                                                <div class="position-relative">
                                                    <pre class="bg-light p-3 rounded" style="font-size: 0.9rem;"><code id="ecommerceScript">&lt;script src="{{ request.url_root }}static/chatwidget.js"&gt;&lt;/script&gt;
&lt;script&gt;
    // Get user info from your system
    const customerInfo = {
        user_id: 'customer_' + Date.now(),
        username: 'Customer',
        email: 'customer@example.com',
        device_id: 'web_store'
    };
    
    ChatWidget.init({
        apiUrl: '{{ request.url_root.rstrip('/') }}',
        ...customerInfo,
        position: 'bottom-right',
        title: 'Customer Support',
        welcomeMessage: 'Hi! How can I help you with your order?'
    });
&lt;/script&gt;</code></pre>
                                                    <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" 
                                                            onclick="copyToClipboard('ecommerceScript')">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Secure Integration Example -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="secureHeading">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#secureExample">
                                                <i class="fas fa-shield-alt me-2"></i> Secure Integration with Domain Restrictions
                                            </button>
                                        </h2>
                                        <div id="secureExample" class="accordion-collapse collapse" data-bs-parent="#integrationExamples">
                                            <div class="accordion-body">
                                                <p>For enhanced security with domain restrictions and API key authentication:</p>
                                                <div class="position-relative">
                                                    <pre class="bg-light p-3 rounded" style="font-size: 0.9rem;"><code id="secureScript">&lt;script src="{{ request.url_root }}static/chatwidget.js"&gt;&lt;/script&gt;
&lt;script&gt;
    ChatWidget.init({
        apiUrl: '{{ request.url_root.rstrip('/') }}',
        user_id: 'secure_user_123',
        username: 'John Doe',
        email: 'john@company.com',
        device_id: 'secure_device',
        apiKey: 'your-api-key-here', // Optional API key
        allowedDomains: ['yourcompany.com', 'subdomain.yourcompany.com'], // Domain restrictions
        position: 'bottom-right',
        title: 'Secure Chat'
    });
&lt;/script&gt;</code></pre>
                                                    <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" 
                                                            onclick="copyToClipboard('secureScript')">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                                <div class="alert alert-info mt-3">
                                                    <i class="fas fa-info-circle"></i> <strong>Security Features:</strong>
                                                    <ul class="mb-0 mt-2">
                                                        <li>Rate limiting (10 requests per minute)</li>
                                                        <li>Input sanitization and XSS protection</li>
                                                        <li>Session timeout (30 minutes)</li>
                                                        <li>Domain-based access control</li>
                                                        <li>Request timeout protection</li>
                                                        <li>Message length limits (2000 characters)</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Widget Size Configuration -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="sizeHeading">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#sizeExample">
                                                <i class="fas fa-expand-arrows-alt me-2"></i> Widget Size Configuration
                                            </button>
                                        </h2>
                                        <div id="sizeExample" class="accordion-collapse collapse" data-bs-parent="#integrationExamples">
                                            <div class="accordion-body">
                                                <p>Configure widget dimensions and button sizes:</p>
                                                
                                                <div class="row mb-3">
                                                    <div class="col-md-4">
                                                        <div class="card">
                                                            <div class="card-body">
                                                                <h6 class="card-title">Small Widget</h6>
                                                                <p class="card-text small">
                                                                    Widget: 300px √ó 400px<br>
                                                                    Button: 60px √ó 60px
                                                                </p>
                                                                <code>widgetSize: 'small'</code>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="card">
                                                            <div class="card-body">
                                                                <h6 class="card-title">Medium Widget</h6>
                                                                <p class="card-text small">
                                                                    Widget: 350px √ó 500px<br>
                                                                    Button: 80px √ó 80px
                                                                </p>
                                                                <code>widgetSize: 'medium'</code>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <div class="card">
                                                            <div class="card-body">
                                                                <h6 class="card-title">Large Widget</h6>
                                                                <p class="card-text small">
                                                                    Widget: 400px √ó 600px<br>
                                                                    Button: 100px √ó 100px
                                                                </p>
                                                                <code>widgetSize: 'large'</code>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="position-relative">
                                                    <pre class="bg-light p-3 rounded" style="font-size: 0.9rem;"><code id="sizeScript">&lt;script src="{{ request.url_root }}static/chatwidget.js"&gt;&lt;/script&gt;
&lt;script&gt;
    ChatWidget.init({
        apiUrl: '{{ request.url_root.rstrip('/') }}',
        widgetSize: 'large',  // 'small', 'medium', 'large'
        position: 'bottom-right',
        title: 'Chat Assistant'
    });
    
    // Or use custom button size
    ChatWidget.init({
        apiUrl: '{{ request.url_root.rstrip('/') }}',
        widgetSize: 'medium',
        buttonSize: 120,  // Custom button size in pixels
        position: 'bottom-right'
    });
&lt;/script&gt;</code></pre>
                                                    <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" 
                                                            onclick="copyToClipboard('sizeScript')">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                                
                                                <div class="alert alert-info mt-3">
                                                    <i class="fas fa-info-circle"></i> <strong>Size Options:</strong>
                                                    <ul class="mb-0 mt-2">
                                                        <li><strong>widgetSize:</strong> 'small', 'medium', 'large' (affects both widget and button)</li>
                                                        <li><strong>buttonSize:</strong> Custom button size in pixels (overrides widgetSize for button)</li>
                                                        <li><strong>position:</strong> 'bottom-right', 'bottom-left'</li>
                                                        <li>Widget automatically adapts to mobile devices</li>
                                                    </ul>
                                                </div>
                                                
                                                <div class="mt-3">
                                                    <a href="/test_widget_sizes.html" class="btn btn-outline-primary" target="_blank">
                                                        <i class="fas fa-external-link-alt"></i> Test Widget Sizes
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Time-Based Greeting Example -->
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="timeGreetingHeading">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#timeGreetingExample">
                                                <i class="fas fa-clock me-2"></i> Time-Based Greetings
                                            </button>
                                        </h2>
                                        <div id="timeGreetingExample" class="accordion-collapse collapse" data-bs-parent="#integrationExamples">
                                            <div class="accordion-body">
                                                <p>Automatically greet first-time users based on the time of day:</p>
                                                
                                                <div class="row mb-3">
                                                    <div class="col-md-3">
                                                        <div class="card text-center">
                                                            <div class="card-body">
                                                                <h6 class="card-title">üåÖ Morning</h6>
                                                                <small class="text-muted">5:00 AM - 11:59 AM</small>
                                                                <p class="card-text mt-2">"Good morning!"</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="card text-center">
                                                            <div class="card-body">
                                                                <h6 class="card-title">‚òÄÔ∏è Afternoon</h6>
                                                                <small class="text-muted">12:00 PM - 4:59 PM</small>
                                                                <p class="card-text mt-2">"Good afternoon!"</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="card text-center">
                                                            <div class="card-body">
                                                                <h6 class="card-title">üåÜ Evening</h6>
                                                                <small class="text-muted">5:00 PM - 9:59 PM</small>
                                                                <p class="card-text mt-2">"Good evening!"</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <div class="card text-center">
                                                            <div class="card-body">
                                                                <h6 class="card-title">üåô Late Hours</h6>
                                                                <small class="text-muted">10:00 PM - 4:59 AM</small>
                                                                <p class="card-text mt-2">"Hello!"</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div class="position-relative">
                                                    <pre class="bg-light p-3 rounded" style="font-size: 0.9rem;"><code id="timeGreetingScript">&lt;script src="{{ request.url_root }}static/chatwidget.js"&gt;&lt;/script&gt;
&lt;script&gt;
    ChatWidget.init({
        apiUrl: '{{ request.url_root.rstrip('/') }}',
        user_id: 'user123',
        username: 'John Doe',
        email: 'john@example.com',
        
        // Enable time-based greetings
        timeBasedGreeting: true,
        personalizedWelcome: true,
        
        position: 'bottom-right',
        title: 'Smart Assistant'
    });
&lt;/script&gt;</code></pre>
                                                    <button class="btn btn-sm btn-outline-secondary position-absolute top-0 end-0 m-2" 
                                                            onclick="copyToClipboard('timeGreetingScript')">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                </div>
                                                
                                                <div class="alert alert-info mt-3">
                                                    <i class="fas fa-info-circle"></i> <strong>How it works:</strong>
                                                    <ul class="mb-0 mt-2">
                                                        <li>Only shows time-based greeting for first-time users (tracked in localStorage)</li>
                                                        <li>Combines with personalized welcome if user info is provided</li>
                                                        <li>Example: "Good morning John! How can I help you today?"</li>
                                                        <li>Falls back to regular welcome message for returning users</li>
                                                        <li>Works across different time zones based on user's local time</li>
                                                    </ul>
                                                </div>
                                                
                                                <div class="mt-3">
                                                    <a href="/test_time_based_greeting.html" class="btn btn-outline-primary" target="_blank">
                                                        <i class="fas fa-external-link-alt"></i> Test Time-Based Greetings
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="alert alert-success mt-4">
                            <i class="fas fa-check-circle"></i> <strong>Features:</strong>
                            <ul class="mb-0 mt-2">
                                <li>‚úì Cross-device conversation continuity for logged-in users</li>
                                <li>‚úì Anonymous session support for guests</li>
                                <li>‚úì Responsive design (mobile & desktop)</li>
                                <li>‚úì Persistent conversation history</li>
                                <li>‚úì Privacy-focused session isolation</li>
                                <li>‚úì Time-based greetings for first-time users</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Settings Section -->
        <div class="row">
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-cogs"></i> Chat Widget Settings
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> <strong>Chat Settings:</strong> Configure typing effects and user experience settings for the chat widget.
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-keyboard"></i> Typing Effects
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="typingEffectEnabled">
                                            <label class="form-check-label" for="typingEffectEnabled">
                                                Enable Typing Effect
                                            </label>
                                        </div>
                                        
                                        <div class="mb-3">
                                            <label for="typingEffectSpeed" class="form-label">Typing Speed (ms per character)</label>
                                            <input type="range" class="form-range" id="typingEffectSpeed" min="10" max="100" step="5" value="25">
                                            <div class="d-flex justify-content-between">
                                                <small class="text-muted">Fast (10ms)</small>
                                                <small class="text-muted" id="typingSpeedValue">25ms</small>
                                                <small class="text-muted">Slow (100ms)</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-mouse"></i> Scroll Behavior
                                    </div>
                                    <div class="card-body">
                                        <div class="form-check form-switch mb-3">
                                            <input class="form-check-input" type="checkbox" id="autoScrollDuringTyping">
                                            <label class="form-check-label" for="autoScrollDuringTyping">
                                                Auto-scroll During Typing
                                            </label>
                                            <small class="form-text text-muted">
                                                When disabled, users can scroll up to read previous messages while the bot is typing without being interrupted.
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <i class="fas fa-save"></i> Actions
                                    </div>
                                    <div class="card-body">
                                        <button class="btn btn-primary" onclick="saveChatSettings()">
                                            <i class="fas fa-save"></i> Save Settings
                                        </button>
                                        <button class="btn btn-outline-secondary ms-2" onclick="loadChatSettings()">
                                            <i class="fas fa-sync"></i> Reload
                                        </button>
                                        
                                        <div id="chatSettingsStatus" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Prompt Management Section -->
        <div class="row">
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-brain"></i> System Prompt Management</span>
                        <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addSystemPromptModal">
                            <i class="fas fa-plus"></i> Add System Prompt
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> <strong>System Prompts:</strong> Control how the AI assistant behaves and makes decisions about tool usage. Only one prompt can be active at a time.
                        </div>
                        <div id="systemPromptsList">
                            <!-- System Prompts will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Tools Management Section -->
        <div class="row">
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-robot"></i> AI Tools Management</span>
                        <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addAiToolModal">
                            <i class="fas fa-plus"></i> Add AI Tool
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> <strong>AI Tools:</strong> Modern AI-driven tool selection using OpenAI Function Calling. The AI automatically decides which tool to use based on natural language understanding rather than keyword matching.
                        </div>
                        <div id="aiToolsList">
                            <!-- AI Tools will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Response Training Section -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span><i class="fas fa-comments"></i> User Feedback & Response Training</span>
                        <div>
                            <button class="btn btn-success btn-sm me-2" data-bs-toggle="modal" data-bs-target="#addResponseTemplateModal">
                                <i class="fas fa-plus"></i> Add Template
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="refreshFeedbackStats()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> <strong>How it works:</strong> Users give thumbs up/down feedback on responses. Analyze poor responses and create better templates to automatically improve similar questions in the future.
                        </div>
                        
                        <div class="alert alert-warning" id="apiQuotaWarning" style="display: none;">
                            <i class="fas fa-exclamation-triangle"></i> <strong>OpenAI API Notice:</strong> The chatbot may show quota exceeded errors. This is due to API usage limits. Please contact support or add OpenAI credits to resolve this issue.
                        </div>
                        
                        <!-- Feedback Stats -->
                        <div class="row mb-4">
                            <div class="col-md-3">
                                <div class="card text-center" style="background: #e8f5e8;">
                                    <div class="card-body">
                                        <h3 class="text-success" id="thumbsUpCount">-</h3>
                                        <p class="mb-0">üëç Helpful</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center" style="background: #ffe8e8;">
                                    <div class="card-body">
                                        <h3 class="text-danger" id="thumbsDownCount">-</h3>
                                        <p class="mb-0">üëé Needs Work</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center" style="background: #e8f4fd;">
                                    <div class="card-body">
                                        <h3 class="text-primary" id="satisfactionRate">-</h3>
                                        <p class="mb-0">Satisfaction Rate</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card text-center" style="background: #f0f0f0;">
                                    <div class="card-body">
                                        <h3 class="text-secondary" id="totalFeedback">-</h3>
                                        <p class="mb-0">Total Feedback</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Navigation Tabs -->
                        <ul class="nav nav-tabs" id="trainingTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="feedback-tab" data-bs-toggle="tab" data-bs-target="#feedback" type="button" role="tab">
                                    <i class="fas fa-comments"></i> All Feedback
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="problematic-tab" data-bs-toggle="tab" data-bs-target="#problematic" type="button" role="tab">
                                    <i class="fas fa-exclamation-triangle text-warning"></i> Poor Responses
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab">
                                    <i class="fas fa-file-alt"></i> Templates
                                </button>
                            </li>
                        </ul>
                        
                        <div class="tab-content" id="trainingTabsContent">
                            <!-- All Feedback Tab -->
                            <div class="tab-pane fade show active" id="feedback" role="tabpanel">
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6>Recent User Feedback</h6>
                                        <select class="form-select form-select-sm" style="width: 150px;" id="feedbackTypeFilter">
                                            <option value="">All Ratings</option>
                                            <option value="thumbs_up">üëç Helpful</option>
                                            <option value="thumbs_down">üëé Needs Work</option>
                                        </select>
                                    </div>
                                    
                                    <div id="feedbackList">
                                        <!-- All feedback will be loaded here -->
                                    </div>
                                    
                                    <!-- Load More Button -->
                                    <div class="text-center mt-3">
                                        <button class="btn btn-outline-secondary" id="loadMoreFeedback" onclick="loadMoreFeedback()" style="display: none;">
                                            Load More Feedback
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Problematic Responses Tab -->
                            <div class="tab-pane fade" id="problematic" role="tabpanel">
                                <div class="mt-3">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <h6>Responses Needing Improvement</h6>
                                        <select class="form-select form-select-sm" style="width: 200px;" id="problemFilter">
                                            <option value="">All Issues</option>
                                            <option value="thumbs_down">üëé Negative Feedback</option>
                                            <option value="vague">Vague Responses</option>
                                            <option value="too_technical">Too Technical</option>
                                            <option value="incorrect">Incorrect Answers</option>
                                            <option value="incomplete">Incomplete Answers</option>
                                        </select>
                                    </div>
                                    
                                    <div id="problematicResponsesList">
                                        <!-- Problematic responses will be loaded here -->
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Response Templates Tab -->
                            <div class="tab-pane fade" id="templates" role="tabpanel">
                                <div class="mt-3">
                                    <div id="responseTemplatesList">
                                        <!-- Response templates will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Logs Section -->
        <div class="row">
            <div class="col-md-12 mb-4">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-list-alt"></i> System Logs
                        </div>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="refreshLogs()" title="Refresh Logs">
                                <i class="fas fa-sync"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="clearLogsDisplay()" title="Clear Display">
                                <i class="fas fa-eraser"></i>
                            </button>
                            <button class="btn btn-outline-info" onclick="downloadLogs()" title="Download Logs">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> <strong>Response Type Tracking:</strong> Monitor how questions are processed through the 4-step pipeline: Templates ‚Üí Small Talk ‚Üí AI Tools ‚Üí RAG Knowledge Base
                        </div>
                        
                        <div class="mb-3">
                            <div class="row">
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="logLevelFilter">
                                        <option value="">All Levels</option>
                                        <option value="INFO">Info</option>
                                        <option value="ERROR">Error</option>
                                        <option value="DEBUG">Debug</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-select form-select-sm" id="responseTypeFilter">
                                        <option value="">All Response Types</option>
                                        <option value="TEMPLATE_MATCH">Template Match</option>
                                        <option value="SMALL_TALK">Small Talk</option>
                                        <option value="AI_TOOL">AI Tool</option>
                                        <option value="RAG_KNOWLEDGE_BASE">RAG Knowledge Base</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="text" class="form-control form-control-sm" id="logSearchFilter" placeholder="Search logs...">
                                </div>
                                <div class="col-md-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="autoRefreshLogs" checked>
                                        <label class="form-check-label small" for="autoRefreshLogs">Auto-refresh</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div id="systemLogs" style="height: 400px; overflow-y: auto; background-color: #1e1e1e; color: #d4d4d4; font-family: 'Courier New', monospace; font-size: 0.875rem; padding: 1rem; border-radius: 0.375rem;">
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-spinner fa-spin"></i> Loading logs...
                            </div>
                        </div>
                        
                        <div class="mt-2 small text-muted">
                            <strong>Legend:</strong>
                            <span class="badge bg-success me-1">üöÄ PROCESSING</span>
                            <span class="badge bg-info me-1">‚úÖ RESPONSE TYPE</span>
                            <span class="badge bg-warning me-1">üîç STEP</span>
                            <span class="badge bg-danger me-1">‚ùå ERROR</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-info-circle"></i> Instructions
                    </div>
                    <div class="card-body">
                        <ol>
                            <li><strong>Upload Documents:</strong> Upload PDF or DOCX files containing the knowledge base for your chatbot.</li>
                            <li><strong>Vectorize:</strong> Click "Vectorize Documents" to process the uploaded files and create embeddings.</li>
                            <li><strong>Test:</strong> Visit the <a href="{{ url_for('chatbot') }}">chatbot interface</a> to test your RAG system.</li>
                            <li><strong>Manage:</strong> You can delete individual files or clear the entire vector index to start fresh.</li>
                        </ol>
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-lightbulb"></i> <strong>Tip:</strong> After uploading new documents, remember to click "Vectorize Documents" to update the knowledge base.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <!-- Add System Prompt Modal -->
    <div class="modal fade" id="addSystemPromptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add System Prompt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addSystemPromptForm">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="addPromptName" class="form-label">Prompt Name</label>
                            <input type="text" class="form-control" id="addPromptName" required>
                            <div class="form-text">Give this prompt a descriptive name</div>
                        </div>
                        <div class="mb-3">
                            <label for="addPromptText" class="form-label">System Prompt</label>
                            <textarea class="form-control" id="addPromptText" rows="15" required></textarea>
                            <div class="form-text">This controls how the AI assistant behaves and makes decisions</div>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="addPromptActive">
                            <label class="form-check-label" for="addPromptActive">Set as active prompt</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-info me-auto" onclick="loadDefaultPrompt('add')">
                            <i class="fas fa-download"></i> Load Default
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Add Prompt</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit System Prompt Modal -->
    <div class="modal fade" id="editSystemPromptModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit System Prompt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editSystemPromptForm">
                    <input type="hidden" id="editPromptId">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="editPromptName" class="form-label">Prompt Name</label>
                            <input type="text" class="form-control" id="editPromptName" required>
                        </div>
                        <div class="mb-3">
                            <label for="editPromptText" class="form-label">System Prompt</label>
                            <textarea class="form-control" id="editPromptText" rows="15" required></textarea>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editPromptActive">
                            <label class="form-check-label" for="editPromptActive">Set as active prompt</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-info me-auto" onclick="loadDefaultPrompt('edit')">
                            <i class="fas fa-download"></i> Load Default
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Update Prompt</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add AI Tool Modal -->
    <div class="modal fade" id="addAiToolModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add AI Tool</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addAiToolForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="addToolName" class="form-label">Tool Name</label>
                                    <input type="text" class="form-control" id="addToolName" required>
                                    <div class="form-text">Function name for OpenAI (e.g., get_weather, check_stock_price)</div>
                                </div>
                                <div class="mb-3">
                                    <label for="addToolDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="addToolDescription" rows="3" required></textarea>
                                    <div class="form-text">Clear description of what this tool does for AI understanding</div>
                                </div>
                                <div class="mb-3">
                                    <label for="addToolPriority" class="form-label">Priority</label>
                                    <input type="number" class="form-control" id="addToolPriority" value="0" min="0" max="100">
                                    <div class="form-text">Higher numbers = preferred tool</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="addToolParameters" class="form-label">Parameters Schema (JSON)</label>
                                    <textarea class="form-control" id="addToolParameters" rows="8" required></textarea>
                                    <div class="form-text">OpenAI function parameters schema in JSON format</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="addToolActive" checked>
                                    <label class="form-check-label" for="addToolActive">Active</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="addToolCurl" class="form-label">Curl Command</label>
                            <textarea class="form-control" id="addToolCurl" rows="3" required></textarea>
                            <div class="form-text">Full curl command. Use {parameter_name} for function parameters</div>
                        </div>
                        <!-- API Test Section -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-vial"></i> API Testing & Response Mapping</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="testApiResponse('add')">
                                            <i class="fas fa-play"></i> Test API Response
                                        </button>
                                        <div id="addApiTestResult" class="d-none">
                                            <div class="alert alert-info">
                                                <strong>API Response:</strong>
                                                <pre id="addApiResponseData" class="mt-2 mb-0"></pre>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="addFieldSelector" class="d-none">
                                            <label class="form-label">Select Fields for Bot Response:</label>
                                            <div id="addFieldCheckboxes" class="mb-2">
                                                <!-- Checkboxes will be populated here -->
                                            </div>
                                            <button type="button" class="btn btn-sm btn-success" onclick="generateResponseMapping('add')">
                                                <i class="fas fa-magic"></i> Generate Mapping
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="addToolResponseMapping" class="form-label">Response Mapping (JSON)</label>
                                            <textarea class="form-control" id="addToolResponseMapping" rows="4"></textarea>
                                            <div class="form-text">Auto-generated based on selected fields above</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="addToolResponseTemplate" class="form-label">Response Template</label>
                                            <textarea class="form-control" id="addToolResponseTemplate" rows="4"></textarea>
                                            <div class="form-text">Optional: Template for AI response formatting</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Add Tool</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit AI Tool Modal -->
    <div class="modal fade" id="editAiToolModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit AI Tool</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editAiToolForm">
                    <input type="hidden" id="editToolId">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editToolName" class="form-label">Tool Name</label>
                                    <input type="text" class="form-control" id="editToolName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editToolDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="editToolDescription" rows="3" required></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="editToolPriority" class="form-label">Priority</label>
                                    <input type="number" class="form-control" id="editToolPriority" min="0" max="100">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editToolParameters" class="form-label">Parameters Schema (JSON)</label>
                                    <textarea class="form-control" id="editToolParameters" rows="8" required></textarea>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editToolActive">
                                    <label class="form-check-label" for="editToolActive">Active</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editToolCurl" class="form-label">Curl Command</label>
                            <textarea class="form-control" id="editToolCurl" rows="3" required></textarea>
                        </div>
                        
                        <!-- API Test Section -->
                        <div class="card mb-3">
                            <div class="card-header">
                                <h6 class="mb-0"><i class="fas fa-vial"></i> API Testing & Response Mapping</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <button type="button" class="btn btn-outline-primary btn-sm mb-3" onclick="testApiResponse('edit')">
                                            <i class="fas fa-play"></i> Test API Response
                                        </button>
                                        <div id="editApiTestResult" class="d-none">
                                            <div class="alert alert-info">
                                                <strong>API Response:</strong>
                                                <pre id="editApiResponseData" class="mt-2 mb-0"></pre>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div id="editFieldSelector" class="d-none">
                                            <label class="form-label">Select Fields for Bot Response:</label>
                                            <div id="editFieldCheckboxes" class="mb-2">
                                                <!-- Checkboxes will be populated here -->
                                            </div>
                                            <button type="button" class="btn btn-sm btn-success" onclick="generateResponseMapping('edit')">
                                                <i class="fas fa-magic"></i> Generate Mapping
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mt-3">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editToolResponseMapping" class="form-label">Response Mapping (JSON)</label>
                                            <textarea class="form-control" id="editToolResponseMapping" rows="4"></textarea>
                                            <div class="form-text">Auto-generated based on selected fields above</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="editToolResponseTemplate" class="form-label">Response Template</label>
                                            <textarea class="form-control" id="editToolResponseTemplate" rows="4"></textarea>
                                            <div class="form-text">Optional: Template for AI response formatting</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Tool</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Response Template Modal -->
    <div class="modal fade" id="addResponseTemplateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Response Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addResponseTemplateForm">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="addTemplateName" class="form-label">Template Name</label>
                                    <input type="text" class="form-control" id="addTemplateName" required>
                                    <div class="form-text">Descriptive name for this response template</div>
                                </div>
                                <div class="mb-3">
                                    <label for="addTemplateDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="addTemplateDescription" rows="2"></textarea>
                                    <div class="form-text">Optional description of when to use this template</div>
                                </div>
                                <div class="mb-3">
                                    <label for="addTemplateCategory" class="form-label">Category</label>
                                    <select class="form-select" id="addTemplateCategory" required>
                                        <option value="">Select category...</option>
                                        <option value="api_clarification">API Clarification</option>
                                        <option value="vague_response">Vague Response Fix</option>
                                        <option value="too_technical">Simplify Technical</option>
                                        <option value="incomplete">Complete Incomplete</option>
                                        <option value="general_help">General Help</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="addTemplatePriority" class="form-label">Priority</label>
                                    <input type="number" class="form-control" id="addTemplatePriority" value="0" min="0" max="100">
                                    <div class="form-text">Higher numbers = checked first</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="addTemplateTriggers" class="form-label">Trigger Keywords</label>
                                    <textarea class="form-control" id="addTemplateTriggers" rows="3" placeholder="api, make api call, call api"></textarea>
                                    <div class="form-text">Comma-separated keywords that trigger this template</div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="addTemplateActive" checked>
                                    <label class="form-check-label" for="addTemplateActive">Active</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="addTemplateRequiresContext">
                                    <label class="form-check-label" for="addTemplateRequiresContext">Requires RAG Context</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="addTemplateText" class="form-label">Improved Response Template</label>
                            <textarea class="form-control" id="addTemplateText" rows="8" required placeholder="Write the improved response that should replace problematic answers..."></textarea>
                            <div class="form-text">This will be the improved response shown to users</div>
                        </div>
                        <div class="mb-3">
                            <label for="addTemplateFallback" class="form-label">Fallback Response</label>
                            <textarea class="form-control" id="addTemplateFallback" rows="2" placeholder="Optional fallback if template fails..."></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-success">Add Template</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Edit Response Template Modal -->
    <div class="modal fade" id="editResponseTemplateModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Response Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="editResponseTemplateForm">
                    <input type="hidden" id="editTemplateId">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTemplateName" class="form-label">Template Name</label>
                                    <input type="text" class="form-control" id="editTemplateName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="editTemplateDescription" class="form-label">Description</label>
                                    <textarea class="form-control" id="editTemplateDescription" rows="2"></textarea>
                                </div>
                                <div class="mb-3">
                                    <label for="editTemplateCategory" class="form-label">Category</label>
                                    <select class="form-select" id="editTemplateCategory" required>
                                        <option value="api_clarification">API Clarification</option>
                                        <option value="vague_response">Vague Response Fix</option>
                                        <option value="too_technical">Simplify Technical</option>
                                        <option value="incomplete">Complete Incomplete</option>
                                        <option value="general_help">General Help</option>
                                        <option value="custom">Custom</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="editTemplatePriority" class="form-label">Priority</label>
                                    <input type="number" class="form-control" id="editTemplatePriority" min="0" max="100">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="editTemplateTriggers" class="form-label">Trigger Keywords</label>
                                    <textarea class="form-control" id="editTemplateTriggers" rows="3"></textarea>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editTemplateActive">
                                    <label class="form-check-label" for="editTemplateActive">Active</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editTemplateRequiresContext">
                                    <label class="form-check-label" for="editTemplateRequiresContext">Requires RAG Context</label>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="editTemplateText" class="form-label">Improved Response Template</label>
                            <textarea class="form-control" id="editTemplateText" rows="8" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="editTemplateFallback" class="form-label">Fallback Response</label>
                            <textarea class="form-control" id="editTemplateFallback" rows="2"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Template</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Feedback Analysis Modal -->
    <div class="modal fade" id="feedbackAnalysisModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Analyze Response</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="feedbackAnalysisForm">
                    <input type="hidden" id="analysisFeedbackId">
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-12">
                                <div class="card mb-3">
                                    <div class="card-header">
                                        <strong>Original Question & Response</strong>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-2">
                                            <strong>User Question:</strong>
                                            <div id="analysisUserQuestion" class="text-muted"></div>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Bot Response:</strong>
                                            <div id="analysisBotResponse" class="text-muted"></div>
                                        </div>
                                        <div>
                                            <strong>Feedback:</strong>
                                            <span id="analysisFeedbackType"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="analysisCategory" class="form-label">Response Category</label>
                                    <select class="form-select" id="analysisCategory">
                                        <option value="">Select category...</option>
                                        <option value="vague">Vague Response</option>
                                        <option value="too_technical">Too Technical</option>
                                        <option value="incorrect">Incorrect Answer</option>
                                        <option value="incomplete">Incomplete Answer</option>
                                        <option value="helpful">Actually Helpful</option>
                                        <option value="needs_context">Needs More Context</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="analysisTrainingPriority" class="form-label">Training Priority</label>
                                    <select class="form-select" id="analysisTrainingPriority">
                                        <option value="normal">Normal</option>
                                        <option value="high">High</option>
                                        <option value="critical">Critical</option>
                                        <option value="low">Low</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="analysisImprovementSuggestions" class="form-label">Improvement Suggestions</label>
                                    <textarea class="form-control" id="analysisImprovementSuggestions" rows="4" placeholder="How can this response be improved?"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="analysisAdminNotes" class="form-label">Admin Notes</label>
                            <textarea class="form-control" id="analysisAdminNotes" rows="3" placeholder="Internal notes about this feedback"></textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Analysis</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Load AI tools and system prompts on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAiTools();
            loadSystemPrompts();
        });

        // System Prompts Management
        function loadSystemPrompts() {
            fetch('/system_prompts')
                .then(response => response.json())
                .then(data => {
                    displaySystemPrompts(data.prompts);
                })
                .catch(error => console.error('Error loading system prompts:', error));
        }

        function displaySystemPrompts(prompts) {
            const promptsList = document.getElementById('systemPromptsList');
            if (!prompts || prompts.length === 0) {
                promptsList.innerHTML = '<p class="text-muted">No system prompts configured yet. <button class="btn btn-sm btn-outline-primary" onclick="createDefaultPrompt()">Create Default</button></p>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += '<thead><tr><th>Name</th><th>Preview</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
            
            prompts.forEach(prompt => {
                const statusBadge = prompt.is_active ? 
                    '<span class="badge bg-success"><i class="fas fa-check"></i> Active</span>' : 
                    '<span class="badge bg-secondary">Inactive</span>';
                
                const preview = prompt.prompt_text.substring(0, 100) + (prompt.prompt_text.length > 100 ? '...' : '');
                const created = new Date(prompt.created_at).toLocaleDateString();
                
                html += `<tr>
                    <td><strong>${prompt.name}</strong></td>
                    <td><small class="text-muted">${preview}</small></td>
                    <td>${statusBadge}</td>
                    <td><small>${created}</small></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editSystemPrompt(${prompt.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        ${!prompt.is_active ? `<button class="btn btn-sm btn-outline-success" onclick="activateSystemPrompt(${prompt.id})">
                            <i class="fas fa-play"></i> Activate
                        </button>` : ''}
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSystemPrompt(${prompt.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            promptsList.innerHTML = html;
        }

        function loadDefaultPrompt(mode) {
            const defaultPrompt = `You are a helpful, knowledgeable AI assistant designed to provide excellent customer support and assistance. You have access to both a knowledge base and API tools to help users.

CORE PRINCIPLES:
- Be friendly, professional, and helpful
- Provide accurate information based on your knowledge base
- Use clear, simple language that users can easily understand
- Be patient and thorough in your explanations
- Always aim to solve the user's problem completely

KNOWLEDGE BASE USAGE:
- Use your knowledge base to answer questions about procedures, instructions, and general information
- Provide step-by-step guidance when users ask "how to" do something
- Explain platform features, capabilities, and limits
- Share best practices and tips

API TOOL USAGE (Conservative):
Only use API tools when users are asking for their CURRENT personal data with direct requests like:
- "give me my [data]" / "show me my [data]" / "what is my [data]"
- "how much [data] do I have" / "how many [data] do I have"

NEVER use API tools for:
- Instructions ("how to", "how do I", "where do I", "what steps")
- General information about the platform
- Capabilities or limits ("how many can I", "what can I do")
- Procedures or processes

RESPONSE STYLE:
- Keep responses conversational and engaging
- Use bullet points or numbered lists for complex information
- Provide examples when helpful
- If you don't know something, say so honestly
- Always end with asking if the user needs any clarification or has other questions

Remember: Your goal is to provide the best possible user experience by being helpful, accurate, and efficient.`;
            
            document.getElementById(mode + 'PromptText').value = defaultPrompt;
            if (!document.getElementById(mode + 'PromptName').value) {
                document.getElementById(mode + 'PromptName').value = 'Default Comprehensive System Prompt';
            }
        }

        function createDefaultPrompt() {
            document.getElementById('addPromptName').value = 'Default Comprehensive System Prompt';
            loadDefaultPrompt('add');
            document.getElementById('addPromptActive').checked = true;
            new bootstrap.Modal(document.getElementById('addSystemPromptModal')).show();
        }

        // System Prompt event handlers
        document.getElementById('addSystemPromptForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('addPromptName').value,
                prompt_text: document.getElementById('addPromptText').value,
                is_active: document.getElementById('addPromptActive').checked
            };
            
            try {
                const response = await fetch('/system_prompts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    loadSystemPrompts();
                    document.getElementById('addSystemPromptForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addSystemPromptModal')).hide();
                    showAlert('System prompt added successfully!', 'success');
                } else {
                    const data = await response.json();
                    showAlert('Error adding system prompt: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Error adding system prompt', 'danger');
            }
        });

        document.getElementById('editSystemPromptForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const promptId = document.getElementById('editPromptId').value;
            const formData = {
                name: document.getElementById('editPromptName').value,
                prompt_text: document.getElementById('editPromptText').value,
                is_active: document.getElementById('editPromptActive').checked
            };
            
            try {
                const response = await fetch(`/system_prompts/${promptId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    loadSystemPrompts();
                    bootstrap.Modal.getInstance(document.getElementById('editSystemPromptModal')).hide();
                    showAlert('System prompt updated successfully!', 'success');
                } else {
                    const data = await response.json();
                    showAlert('Error updating system prompt: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Error updating system prompt', 'danger');
            }
        });

        function editSystemPrompt(promptId) {
            fetch('/system_prompts')
                .then(response => response.json())
                .then(data => {
                    const prompt = data.prompts.find(p => p.id === promptId);
                    if (prompt) {
                        document.getElementById('editPromptId').value = prompt.id;
                        document.getElementById('editPromptName').value = prompt.name;
                        document.getElementById('editPromptText').value = prompt.prompt_text;
                        document.getElementById('editPromptActive').checked = prompt.is_active;
                        
                        new bootstrap.Modal(document.getElementById('editSystemPromptModal')).show();
                    }
                })
                .catch(error => console.error('Error loading system prompt:', error));
        }

        function activateSystemPrompt(promptId) {
            fetch(`/system_prompts/${promptId}/activate`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadSystemPrompts();
                    showAlert('System prompt activated!', 'success');
                } else {
                    showAlert('Error activating system prompt', 'danger');
                }
            })
            .catch(error => {
                showAlert('Error activating system prompt', 'danger');
            });
        }

        function deleteSystemPrompt(promptId) {
            if (confirm('Are you sure you want to delete this system prompt?')) {
                fetch(`/system_prompts/${promptId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadSystemPrompts();
                        showAlert('System prompt deleted!', 'success');
                    } else {
                        showAlert('Error deleting system prompt', 'danger');
                    }
                })
                .catch(error => {
                    showAlert('Error deleting system prompt', 'danger');
                });
            }
        }

        // AI Tools Management
        function loadAiTools() {
            fetch('/ai_tools')
                .then(response => response.json())
                .then(data => {
                    displayAiTools(data.tools);
                })
                .catch(error => console.error('Error loading AI tools:', error));
        }

        function displayAiTools(tools) {
            const toolsList = document.getElementById('aiToolsList');
            if (!tools || tools.length === 0) {
                toolsList.innerHTML = '<p class="text-muted">No AI tools configured yet.</p>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += '<thead><tr><th>Name</th><th>Description</th><th>Priority</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
            
            tools.forEach(tool => {
                const statusBadge = tool.active ? 
                    '<span class="badge bg-success">Active</span>' : 
                    '<span class="badge bg-secondary">Inactive</span>';
                
                html += `<tr>
                    <td><strong>${tool.name}</strong></td>
                    <td>${tool.description.substring(0, 80)}${tool.description.length > 80 ? '...' : ''}</td>
                    <td><span class="badge bg-primary">${tool.priority}</span></td>
                    <td>${statusBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editAiTool(${tool.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-${tool.active ? 'warning' : 'success'}" 
                                onclick="toggleAiTool(${tool.id})">
                            <i class="fas fa-${tool.active ? 'pause' : 'play'}"></i> ${tool.active ? 'Disable' : 'Enable'}
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteAiTool(${tool.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            toolsList.innerHTML = html;
        }

        // AI Tools event handlers
        document.getElementById('addAiToolForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                name: document.getElementById('addToolName').value,
                description: document.getElementById('addToolDescription').value,
                parameters: document.getElementById('addToolParameters').value,
                curl_command: document.getElementById('addToolCurl').value,
                response_mapping: document.getElementById('addToolResponseMapping').value,
                response_template: document.getElementById('addToolResponseTemplate').value,
                priority: document.getElementById('addToolPriority').value,
                active: document.getElementById('addToolActive').checked
            };
            
            try {
                const response = await fetch('/ai_tools', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    loadAiTools();
                    document.getElementById('addAiToolForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addAiToolModal')).hide();
                    showAlert('AI tool added successfully!', 'success');
                } else {
                    const data = await response.json();
                    showAlert('Error adding AI tool: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Error adding AI tool', 'danger');
            }
        });

        document.getElementById('editAiToolForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const toolId = document.getElementById('editToolId').value;
            const formData = {
                name: document.getElementById('editToolName').value,
                description: document.getElementById('editToolDescription').value,
                parameters: document.getElementById('editToolParameters').value,
                curl_command: document.getElementById('editToolCurl').value,
                response_mapping: document.getElementById('editToolResponseMapping').value,
                response_template: document.getElementById('editToolResponseTemplate').value,
                priority: document.getElementById('editToolPriority').value,
                active: document.getElementById('editToolActive').checked
            };
            
            try {
                const response = await fetch(`/ai_tools/${toolId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    loadAiTools();
                    bootstrap.Modal.getInstance(document.getElementById('editAiToolModal')).hide();
                    showAlert('AI tool updated successfully!', 'success');
                } else {
                    const data = await response.json();
                    showAlert('Error updating AI tool: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Error updating AI tool', 'danger');
            }
        });

        function editAiTool(toolId) {
            fetch(`/ai_tools`)
                .then(response => response.json())
                .then(data => {
                    const tool = data.tools.find(t => t.id === toolId);
                    if (tool) {
                        document.getElementById('editToolId').value = tool.id;
                        document.getElementById('editToolName').value = tool.name;
                        document.getElementById('editToolDescription').value = tool.description;
                        document.getElementById('editToolParameters').value = tool.parameters;
                        document.getElementById('editToolCurl').value = tool.curl_command;
                        document.getElementById('editToolResponseMapping').value = tool.response_mapping || '';
                        document.getElementById('editToolResponseTemplate').value = tool.response_template || '';
                        document.getElementById('editToolPriority').value = tool.priority;
                        document.getElementById('editToolActive').checked = tool.active;
                        
                        new bootstrap.Modal(document.getElementById('editAiToolModal')).show();
                    }
                })
                .catch(error => console.error('Error loading AI tool:', error));
        }

        function toggleAiTool(toolId) {
            fetch(`/ai_tools/${toolId}/toggle`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadAiTools();
                    showAlert('AI tool status updated!', 'success');
                } else {
                    showAlert('Error updating AI tool status', 'danger');
                }
            })
            .catch(error => {
                showAlert('Error updating AI tool status', 'danger');
            });
        }

        function deleteAiTool(toolId) {
            if (confirm('Are you sure you want to delete this AI tool?')) {
                fetch(`/ai_tools/${toolId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadAiTools();
                        showAlert('AI tool deleted successfully!', 'success');
                    } else {
                        showAlert('Error deleting AI tool', 'danger');
                    }
                })
                .catch(error => {
                    showAlert('Error deleting AI tool', 'danger');
                });
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.container').firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }



        // Copy to clipboard function
        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                // Find the button that was clicked
                const button = document.querySelector(`[onclick="copyToClipboard('${elementId}')"]`);
                const originalHtml = button.innerHTML;
                
                // Show success feedback
                button.innerHTML = '<i class="fas fa-check"></i> Copied!';
                button.classList.add('btn-success');
                
                // Reset after 2 seconds
                setTimeout(() => {
                    button.innerHTML = originalHtml;
                    button.classList.remove('btn-success');
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy to clipboard');
            });
        }

        // API Testing Functions
        async function testApiResponse(modalType) {
            const curlCommand = document.getElementById(`${modalType}ToolCurl`).value;
            const button = document.querySelector(`[onclick="testApiResponse('${modalType}')"]`);
            
            if (!curlCommand) {
                alert('Please enter a curl command first');
                return;
            }
            
            // Show loading state
            const originalHtml = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            button.disabled = true;
            
            try {
                const response = await fetch('/test_api_response', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ curl_command: curlCommand })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Show API response
                    document.getElementById(`${modalType}ApiResponseData`).textContent = JSON.stringify(result.data, null, 2);
                    document.getElementById(`${modalType}ApiTestResult`).classList.remove('d-none');
                    
                    // Generate field checkboxes
                    generateFieldCheckboxes(result.data, modalType);
                    document.getElementById(`${modalType}FieldSelector`).classList.remove('d-none');
                } else {
                    alert('API test failed: ' + result.error);
                }
            } catch (error) {
                alert('Error testing API: ' + error.message);
            } finally {
                // Reset button
                button.innerHTML = originalHtml;
                button.disabled = false;
            }
        }

        function generateFieldCheckboxes(data, modalType) {
            const checkboxContainer = document.getElementById(`${modalType}FieldCheckboxes`);
            checkboxContainer.innerHTML = '';
            
            // Function to recursively extract field paths
            function extractFields(obj, prefix = '') {
                const fields = [];
                if (Array.isArray(obj)) {
                    if (obj.length > 0) {
                        // For arrays, show the structure of the first element
                        fields.push(...extractFields(obj[0], prefix + '[0]'));
                    }
                } else if (typeof obj === 'object' && obj !== null) {
                    for (const key in obj) {
                        const path = prefix ? `${prefix}.${key}` : key;
                        fields.push({ path: path, value: obj[key], type: typeof obj[key] });
                        
                        // Recursively handle nested objects (limited depth)
                        if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
                            fields.push(...extractFields(obj[key], path));
                        }
                    }
                }
                return fields;
            }
            
            const fields = extractFields(data);
            
            fields.forEach((field, index) => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'form-check';
                
                // Create user-friendly field name
                const friendlyName = field.path.replace(/\[0\]\./g, '').replace(/\./g, '_');
                
                checkboxDiv.innerHTML = `
                    <input class="form-check-input field-checkbox" type="checkbox" 
                           id="${modalType}Field${index}" 
                           data-path="${field.path}" 
                           data-friendly-name="${friendlyName}">
                    <label class="form-check-label" for="${modalType}Field${index}">
                        <code>${friendlyName}</code> 
                        <small class="text-muted">(${field.type})</small>
                        <br>
                        <small class="text-secondary">Path: ${field.path}</small>
                        <br>
                        <small class="text-info">Value: ${JSON.stringify(field.value)}</small>
                    </label>
                `;
                
                checkboxContainer.appendChild(checkboxDiv);
            });
        }

        function generateResponseMapping(modalType) {
            const selectedFields = {};
            const checkboxes = document.querySelectorAll(`#${modalType}FieldCheckboxes .field-checkbox:checked`);
            
            if (checkboxes.length === 0) {
                alert('Please select at least one field');
                return;
            }
            
            checkboxes.forEach(checkbox => {
                const path = checkbox.dataset.path;
                const friendlyName = checkbox.dataset.friendlyName;
                selectedFields[friendlyName] = path;
            });
            
            // Generate the response mapping JSON
            const responseMapping = {
                fields: selectedFields
            };
            
            // Update the response mapping textarea
            document.getElementById(`${modalType}ToolResponseMapping`).value = JSON.stringify(responseMapping, null, 2);
            
            // Generate a sample response template
            const templateFields = Object.keys(selectedFields).map(field => `**${field.replace(/_/g, ' ').toUpperCase()}**: {${field}}`).join('\n- ');
            const template = `Based on the API response, here's your information:\n\n- ${templateFields}\n\nLet me know if you need any additional details!`;
            
            document.getElementById(`${modalType}ToolResponseTemplate`).value = template;
            
            // Show success message
            alert('Response mapping and template generated successfully!');
        }

        // Widget Icon Management Functions
        function initializeIconUpload() {
            console.log('Initializing icon upload...');
            const iconUploadForm = document.getElementById('iconUploadForm');
            if (!iconUploadForm) {
                console.error('Icon upload form not found!');
                return;
            }
            
            console.log('Adding event listener to form...');
            iconUploadForm.addEventListener('submit', function(e) {
                console.log('Form submitted, preventing default...');
                e.preventDefault();
                e.stopPropagation();
                uploadIcon();
                return false;
            });
            
            // Also handle button clicks directly
            const uploadButton = iconUploadForm.querySelector('button[type="submit"]');
            if (uploadButton) {
                uploadButton.addEventListener('click', function(e) {
                    console.log('Upload button clicked, preventing default...');
                    e.preventDefault();
                    e.stopPropagation();
                    uploadIcon();
                    return false;
                });
            }
            
            // Load current icon on page load
            loadCurrentIcon();
        }

        function loadCurrentIcon() {
            console.log('Loading current icon...');
            fetch('/api/widget/icon')
                .then(response => response.json())
                .then(data => {
                    console.log('Current icon response:', data);
                    if (data.iconUrl) {
                        updateIconDisplay(data.iconUrl);
                    }
                })
                .catch(error => {
                    console.error('Error loading current icon:', error);
                });
        }

        function uploadIcon() {
            console.log('Starting icon upload...');
            const fileInput = document.getElementById('iconFile');
            const file = fileInput.files[0];
            
            console.log('Selected file:', file);
            
            if (!file) {
                showIconStatus('Please select a file first', 'danger');
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showIconStatus('Please select an image file', 'danger');
                return;
            }
            
            // Validate file size (max 2MB)
            if (file.size > 2 * 1024 * 1024) {
                showIconStatus('File size must be less than 2MB', 'danger');
                return;
            }
            
            const formData = new FormData();
            formData.append('iconFile', file);
            
            showIconStatus('Uploading icon...', 'info');
            console.log('Sending upload request...');
            
            fetch('/api/widget/icon', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Upload response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Upload response data:', data);
                if (data.success) {
                    showIconStatus('Icon uploaded successfully!', 'success');
                    updateIconDisplay(data.iconUrl);
                    fileInput.value = ''; // Clear the file input
                    updateWidgetExamples(data.iconUrl);
                } else {
                    showIconStatus(data.error || 'Upload failed', 'danger');
                }
            })
            .catch(error => {
                console.error('Error uploading icon:', error);
                showIconStatus('Upload failed. Please try again.', 'danger');
            });
        }

        function updateIconDisplay(iconUrl) {
            const currentIconDiv = document.getElementById('currentIcon');
            currentIconDiv.innerHTML = `
                <img src="${iconUrl}" alt="Custom Icon" style="width: 48px; height: 48px; border-radius: 50%;">
                <p class="text-muted mt-2">Custom Icon</p>
            `;
        }

        window.resetToDefaultIcon = function() {
            if (confirm('Are you sure you want to reset to the default icon?')) {
                fetch('/api/widget/icon', {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showIconStatus('Reset to default icon', 'success');
                        const currentIconDiv = document.getElementById('currentIcon');
                        currentIconDiv.innerHTML = `
                            <i class="fas fa-comments fa-3x text-primary"></i>
                            <p class="text-muted mt-2">Default Chat Icon</p>
                        `;
                        updateWidgetExamples(null);
                    } else {
                        showIconStatus(data.error || 'Reset failed', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error resetting icon:', error);
                    showIconStatus('Reset failed. Please try again.', 'danger');
                });
            }
        }

        window.previewIcon = function() {
            // Open a new window with the widget demo that includes the current icon
            window.open('/widget_demo', '_blank');
        }

        function showIconStatus(message, type) {
            const statusDiv = document.getElementById('iconUploadStatus');
            statusDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        function updateWidgetExamples(iconUrl) {
            // Update all widget code examples to include the custom icon
            const iconConfig = iconUrl ? `        iconUrl: '${iconUrl}',` : '';
            
            // Update basic widget script
            const basicScript = document.getElementById('basicWidgetScript');
            const basicContent = basicScript.textContent;
            const updatedBasicContent = basicContent.replace(
                /        persistentHistoryCount: 10  \/\/ Number of messages to persist/,
                '        persistentHistoryCount: 10,  // Number of messages to persist\n' + iconConfig
            );
            basicScript.textContent = updatedBasicContent;
            
            // Update other script examples too
            updateScriptExample('anonymousScript', iconConfig);
            updateScriptExample('dynamicScript', iconConfig);
            updateScriptExample('ecommerceScript', iconConfig);
            updateScriptExample('secureScript', iconConfig);
        }

        function updateScriptExample(scriptId, iconConfig) {
            const scriptElement = document.getElementById(scriptId);
            if (scriptElement) {
                let content = scriptElement.textContent;
                
                // Remove existing iconUrl if present
                content = content.replace(/        iconUrl: '[^']*',\n?/g, '');
                
                // Add new iconUrl if provided
                if (iconConfig) {
                    content = content.replace(
                        /    \}\);/,
                        iconConfig + '\n    });'
                    );
                }
                
                scriptElement.textContent = content;
            }
        }



        // Problematic Responses Management Functions
        function loadProblematicResponses() {
            const filter = document.getElementById('problemFilter') ? document.getElementById('problemFilter').value : '';
            let url = '/feedback?feedback_type=thumbs_down&limit=50';
            
            if (filter && filter !== 'thumbs_down') {
                url += `&response_category=${filter}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    displayProblematicResponses(data.feedback || []);
                })
                .catch(error => {
                    console.error('Error loading problematic responses:', error);
                    document.getElementById('problematicResponsesList').innerHTML = 
                        '<div class="text-center text-danger py-4">Error loading problematic responses.</div>';
                });
        }

        function displayProblematicResponses(responses) {
            const container = document.getElementById('problematicResponsesList');
            if (!responses || responses.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4">No problematic responses found.</div>';
                return;
            }
            
            let html = '';
            responses.forEach(response => {
                const categoryBadge = response.response_category ? 
                    `<span class="badge bg-warning">${response.response_category}</span>` : 
                    '<span class="badge bg-secondary">Unclassified</span>';
                
                const priorityBadge = response.training_priority ? 
                    `<span class="badge bg-${getPriorityColor(response.training_priority)}">${response.training_priority}</span>` : 
                    '<span class="badge bg-secondary">Normal</span>';
                
                const timestamp = new Date(response.feedback_timestamp).toLocaleString();
                
                html += `
                    <div class="card mb-3 border-danger">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="d-flex gap-2 align-items-center">
                                    <span class="text-danger">üëé</span>
                                    ${categoryBadge}
                                    ${priorityBadge}
                                    <small class="text-muted">${timestamp}</small>
                                </div>
                                <div class="btn-group-sm">
                                    <button class="btn btn-sm btn-outline-info" onclick="analyzeFeedback(${response.id})" 
                                            title="Analyze Response">
                                        <i class="fas fa-chart-line"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-success" onclick="createTemplate(${response.id})" 
                                            title="Create Template">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="mb-2">
                                <strong>User Question:</strong>
                                <div class="text-muted">${response.user_question}</div>
                            </div>
                            
                            <div class="mb-2">
                                <strong>Bot Response:</strong>
                                <div class="text-muted">${response.bot_response.length > 200 ? 
                                    response.bot_response.substring(0, 200) + '...' : 
                                    response.bot_response}</div>
                            </div>
                            
                            ${response.improvement_suggestions ? `
                            <div class="mb-2">
                                <strong>Improvement Suggestions:</strong>
                                <div class="text-success small">${response.improvement_suggestions}</div>
                            </div>
                            ` : ''}
                            
                            ${response.admin_notes ? `
                            <div class="mb-2">
                                <strong>Admin Notes:</strong>
                                <div class="text-info small">${response.admin_notes}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function getPriorityColor(priority) {
            switch(priority) {
                case 'critical': return 'danger';
                case 'high': return 'warning';
                case 'normal': return 'primary';
                case 'low': return 'secondary';
                default: return 'secondary';
            }
        }

        function createTemplate(feedbackId) {
            // Pre-fill the add template modal with data from this feedback
            fetch('/feedback')
                .then(response => response.json())
                .then(data => {
                    const feedback = data.feedback.find(f => f.id === feedbackId);
                    if (feedback) {
                        document.getElementById('addTemplateName').value = `Fix: ${feedback.user_question.substring(0, 30)}...`;
                        document.getElementById('addTemplateDescription').value = `Improved response for: ${feedback.user_question}`;
                        document.getElementById('addTemplateTriggers').value = feedback.user_question;
                        
                        // Suggest improved response based on improvement suggestions
                        if (feedback.improvement_suggestions) {
                            document.getElementById('addTemplateText').value = feedback.improvement_suggestions;
                        }
                        
                        new bootstrap.Modal(document.getElementById('addResponseTemplateModal')).show();
                    }
                })
                .catch(error => console.error('Error creating template:', error));
        }

        // Response Template Management Functions
        function loadResponseTemplates() {
            fetch('/response_templates')
                .then(response => response.json())
                .then(data => {
                    displayResponseTemplates(data.templates || []);
                })
                .catch(error => console.error('Error loading response templates:', error));
        }

        function displayResponseTemplates(templates) {
            const templatesContainer = document.getElementById('responseTemplatesList');
            if (!templates || templates.length === 0) {
                templatesContainer.innerHTML = '<p class="text-muted">No response templates configured yet.</p>';
                return;
            }
            
            let html = '<div class="table-responsive"><table class="table table-hover">';
            html += '<thead><tr><th>Name</th><th>Category</th><th>Priority</th><th>Status</th><th>Usage</th><th>Actions</th></tr></thead><tbody>';
            
            templates.forEach(template => {
                const statusBadge = template.is_active ? 
                    '<span class="badge bg-success">Active</span>' : 
                    '<span class="badge bg-secondary">Inactive</span>';
                
                html += `<tr>
                    <td><strong>${template.name}</strong></td>
                    <td><span class="badge bg-info">${template.category || 'N/A'}</span></td>
                    <td><span class="badge bg-primary">${template.priority}</span></td>
                    <td>${statusBadge}</td>
                    <td><small>${template.usage_count || 0} uses</small></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editResponseTemplate(${template.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteResponseTemplate(${template.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </td>
                </tr>`;
            });
            
            html += '</tbody></table></div>';
            templatesContainer.innerHTML = html;
        }

        // Response Template event handlers
        document.getElementById('addResponseTemplateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const triggerKeywords = document.getElementById('addTemplateTriggers').value.split(',').map(k => k.trim()).filter(k => k);
            
            const formData = {
                name: document.getElementById('addTemplateName').value,
                description: document.getElementById('addTemplateDescription').value,
                trigger_keywords: JSON.stringify(triggerKeywords),
                question_patterns: JSON.stringify([]), // Can be enhanced later
                categories: JSON.stringify([document.getElementById('addTemplateCategory').value]),
                template_text: document.getElementById('addTemplateText').value,
                fallback_response: document.getElementById('addTemplateFallback').value,
                priority: document.getElementById('addTemplatePriority').value,
                is_active: document.getElementById('addTemplateActive').checked,
                requires_context: document.getElementById('addTemplateRequiresContext').checked
            };
            
            try {
                const response = await fetch('/response_templates', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    loadResponseTemplates();
                    document.getElementById('addResponseTemplateForm').reset();
                    bootstrap.Modal.getInstance(document.getElementById('addResponseTemplateModal')).hide();
                    showAlert('Response template added successfully!', 'success');
                } else {
                    const data = await response.json();
                    showAlert('Error adding response template: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Error adding response template', 'danger');
            }
        });

        document.getElementById('editResponseTemplateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const templateId = document.getElementById('editTemplateId').value;
            const triggerKeywords = document.getElementById('editTemplateTriggers').value.split(',').map(k => k.trim()).filter(k => k);
            
            const formData = {
                name: document.getElementById('editTemplateName').value,
                description: document.getElementById('editTemplateDescription').value,
                trigger_keywords: JSON.stringify(triggerKeywords),
                question_patterns: JSON.stringify([]), // Can be enhanced later
                categories: JSON.stringify([document.getElementById('editTemplateCategory').value]),
                template_text: document.getElementById('editTemplateText').value,
                fallback_response: document.getElementById('editTemplateFallback').value,
                priority: document.getElementById('editTemplatePriority').value,
                is_active: document.getElementById('editTemplateActive').checked,
                requires_context: document.getElementById('editTemplateRequiresContext').checked
            };
            
            try {
                const response = await fetch(`/response_templates/${templateId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    loadResponseTemplates();
                    bootstrap.Modal.getInstance(document.getElementById('editResponseTemplateModal')).hide();
                    showAlert('Response template updated successfully!', 'success');
                } else {
                    const data = await response.json();
                    showAlert('Error updating response template: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Error updating response template', 'danger');
            }
        });

        function editResponseTemplate(templateId) {
            fetch('/response_templates')
                .then(response => response.json())
                .then(data => {
                    const template = data.templates.find(t => t.id === templateId);
                    if (template) {
                        document.getElementById('editTemplateId').value = template.id;
                        document.getElementById('editTemplateName').value = template.name;
                        document.getElementById('editTemplateDescription').value = template.description || '';
                        document.getElementById('editTemplateCategory').value = JSON.parse(template.categories || '[]')[0] || '';
                        document.getElementById('editTemplateTriggers').value = JSON.parse(template.trigger_keywords || '[]').join(', ');
                        document.getElementById('editTemplateText').value = template.template_text;
                        document.getElementById('editTemplateFallback').value = template.fallback_response || '';
                        document.getElementById('editTemplatePriority').value = template.priority;
                        document.getElementById('editTemplateActive').checked = template.is_active;
                        document.getElementById('editTemplateRequiresContext').checked = template.requires_context;
                        
                        new bootstrap.Modal(document.getElementById('editResponseTemplateModal')).show();
                    }
                })
                .catch(error => console.error('Error loading response template:', error));
        }

        function deleteResponseTemplate(templateId) {
            if (confirm('Are you sure you want to delete this response template?')) {
                fetch(`/response_templates/${templateId}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadResponseTemplates();
                        showAlert('Response template deleted successfully!', 'success');
                    } else {
                        showAlert('Error deleting response template', 'danger');
                    }
                })
                .catch(error => {
                    showAlert('Error deleting response template', 'danger');
                });
            }
        }

        // Feedback Analysis Functions
        document.getElementById('feedbackAnalysisForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const feedbackId = document.getElementById('analysisFeedbackId').value;
            const formData = {
                response_category: document.getElementById('analysisCategory').value,
                improvement_suggestions: document.getElementById('analysisImprovementSuggestions').value,
                admin_notes: document.getElementById('analysisAdminNotes').value,
                training_priority: document.getElementById('analysisTrainingPriority').value
            };
            
            try {
                const response = await fetch(`/feedback/${feedbackId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });
                
                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('feedbackAnalysisModal')).hide();
                    showAlert('Response analysis saved successfully!', 'success');
                    loadFeedback(true); // Refresh the feedback list
                } else {
                    const data = await response.json();
                    showAlert('Error saving analysis: ' + data.error, 'danger');
                }
            } catch (error) {
                showAlert('Error saving analysis', 'danger');
            }
        });

        function analyzeFeedback(feedbackId) {
            // Find the feedback data from the current list
            fetch('/feedback')
                .then(response => response.json())
                .then(data => {
                    const feedback = data.feedback.find(f => f.id === feedbackId);
                    if (feedback) {
                        document.getElementById('analysisFeedbackId').value = feedback.id;
                        document.getElementById('analysisUserQuestion').textContent = feedback.user_question;
                        document.getElementById('analysisBotResponse').textContent = feedback.bot_response;
                        document.getElementById('analysisFeedbackType').innerHTML = 
                            feedback.feedback_type === 'positive' ? 
                            '<span class="badge bg-success">üëç Positive</span>' : 
                            '<span class="badge bg-danger">üëé Negative</span>';
                        
                        // Pre-fill existing analysis if available
                        document.getElementById('analysisCategory').value = feedback.response_category || '';
                        document.getElementById('analysisImprovementSuggestions').value = feedback.improvement_suggestions || '';
                        document.getElementById('analysisAdminNotes').value = feedback.admin_notes || '';
                        document.getElementById('analysisTrainingPriority').value = feedback.training_priority || 'normal';
                        
                        new bootstrap.Modal(document.getElementById('feedbackAnalysisModal')).show();
                    }
                })
                .catch(error => console.error('Error loading feedback for analysis:', error));
        }

        // Initialize icon upload when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing icon upload...');
            initializeIconUpload();
            
            // Initialize feedback management
            loadFeedbackStats();
            loadFeedback(true);
            
            // Show API quota warning - we know there's an issue from the logs
            document.getElementById('apiQuotaWarning').style.display = 'block';
            
            // Initialize response templates
            loadResponseTemplates();
            
            // Initialize problematic responses
            loadProblematicResponses();
            
            // Initialize system logs
            initializeSystemLogs();
            
            // Add feedback filter event listener for the new consolidated interface
            const feedbackTypeFilter = document.getElementById('feedbackTypeFilter');
            if (feedbackTypeFilter) {
                feedbackTypeFilter.addEventListener('change', function() {
                    loadFeedback(true); // Reset and reload with filter
                });
            }
            
            // Add problem filter event listener
            const problemFilter = document.getElementById('problemFilter');
            if (problemFilter) {
                problemFilter.addEventListener('change', function() {
                    loadProblematicResponses(); // Reload with filter
                });
            }
        });

        // ===========================
        // FEEDBACK MANAGEMENT FUNCTIONS
        // ===========================
        
        let currentFeedbackOffset = 0;
        const feedbackLimit = 20;
        
        function refreshFeedbackStats() {
            loadFeedbackStats();
            loadFeedback(true); // true = reset list
        }
        
        function loadFeedbackStats() {
            fetch('/feedback/stats')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        document.getElementById('thumbsUpCount').textContent = data.stats.thumbs_up;
                        document.getElementById('thumbsDownCount').textContent = data.stats.thumbs_down;
                        document.getElementById('satisfactionRate').textContent = data.stats.satisfaction_rate + '%';
                        document.getElementById('totalFeedback').textContent = data.stats.total_feedback;
                    }
                })
                .catch(error => {
                    console.error('Error loading feedback stats:', error);
                });
        }
        
        function loadFeedback(reset = false) {
            if (reset) {
                currentFeedbackOffset = 0;
            }
            
            const filterElement = document.getElementById('feedbackTypeFilter');
            const filterType = filterElement ? filterElement.value : '';
            let url = `/feedback?limit=${feedbackLimit}&offset=${currentFeedbackOffset}`;
            
            if (filterType) {
                url += `&feedback_type=${filterType}`;
            }
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const feedbackList = document.getElementById('feedbackList');
                        
                        if (reset) {
                            feedbackList.innerHTML = '';
                        }
                        
                        if (data.feedback.length === 0 && reset) {
                            feedbackList.innerHTML = '<div class="text-center text-muted py-4">No feedback records found.</div>';
                            document.getElementById('loadMoreFeedback').style.display = 'none';
                            return;
                        }
                        
                        data.feedback.forEach(feedback => {
                            const feedbackItem = createFeedbackItem(feedback);
                            feedbackList.appendChild(feedbackItem);
                        });
                        
                        // Show/hide load more button
                        const loadMoreBtn = document.getElementById('loadMoreFeedback');
                        if (data.feedback.length === feedbackLimit) {
                            loadMoreBtn.style.display = 'inline-block';
                        } else {
                            loadMoreBtn.style.display = 'none';
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading feedback:', error);
                    if (reset) {
                        document.getElementById('feedbackList').innerHTML = 
                            '<div class="text-center text-danger py-4">Error loading feedback records.</div>';
                    }
                });
        }
        
        function createFeedbackItem(feedback) {
            const item = document.createElement('div');
            item.className = 'card mb-3';
            
            const feedbackIcon = feedback.feedback_type === 'thumbs_up' ? 'üëç' : 'üëé';
            const feedbackClass = feedback.feedback_type === 'thumbs_up' ? 'text-success' : 'text-danger';
            const timestamp = new Date(feedback.feedback_timestamp).toLocaleString();
            
            // Truncate long text for display
            const truncatedQuestion = feedback.user_question.length > 100 ? 
                feedback.user_question.substring(0, 100) + '...' : feedback.user_question;
            const truncatedResponse = feedback.bot_response.length > 200 ? 
                feedback.bot_response.substring(0, 200) + '...' : feedback.bot_response;
            
            item.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center gap-2 mb-2">
                                <span class="badge bg-primary">${feedback.response_type}</span>
                                <span class="${feedbackClass}" style="font-size: 1.2em;">${feedbackIcon}</span>
                                <small class="text-muted">${timestamp}</small>
                            </div>
                            
                            <div class="mb-2">
                                <strong>User:</strong> <em>${truncatedQuestion}</em>
                            </div>
                            
                            <div class="mb-2">
                                <strong>Bot Response:</strong> ${truncatedResponse}
                            </div>
                            
                            ${feedback.username || feedback.user_id ? `
                            <div class="mb-2">
                                <small class="text-muted">
                                    User: ${feedback.username || feedback.user_id || 'Anonymous'}
                                    ${feedback.email ? `(${feedback.email})` : ''}
                                </small>
                            </div>
                            ` : ''}
                            
                            ${feedback.feedback_comment ? `
                            <div class="mb-2">
                                <strong>Comment:</strong> ${feedback.feedback_comment}
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="btn-group-vertical ms-3">
                            <button class="btn btn-sm btn-outline-secondary" onclick="viewFullFeedback(${feedback.id})"
                                    title="View Full Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-info mt-1" onclick="analyzeFeedback(${feedback.id})"
                                    title="Analyze Response">
                                <i class="fas fa-chart-line"></i>
                            </button>
                            ${feedback.used_for_training ? 
                                '<span class="badge bg-success mt-1">Used for Training</span>' : 
                                `<button class="btn btn-sm btn-outline-primary mt-1" 
                                         onclick="markForTraining(${feedback.id})" 
                                         title="Mark for Training">
                                    <i class="fas fa-graduation-cap"></i>
                                </button>`
                            }
                        </div>
                    </div>
                </div>
            `;
            
            return item;
        }
        
        function loadMoreFeedback() {
            currentFeedbackOffset += feedbackLimit;
            loadFeedback(false);
        }
        
        function markForTraining(feedbackId) {
            fetch(`/feedback/${feedbackId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    used_for_training: true,
                    training_notes: 'Marked for training from admin panel'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showAlert('Feedback marked for training!', 'success');
                    loadFeedback(true); // Refresh the list
                } else {
                    showAlert('Error marking feedback for training', 'danger');
                }
            })
            .catch(error => {
                console.error('Error marking for training:', error);
                showAlert('Error marking feedback for training', 'danger');
            });
        }
        
        function viewFullFeedback(feedbackId) {
            // This could open a modal with full feedback details
            // For now, just show an alert with basic info
            fetch(`/feedback?limit=1&offset=0`)
                .then(response => response.json())
                .then(data => {
                    const feedback = data.feedback.find(f => f.id === feedbackId);
                    if (feedback) {
                        alert(`Full Feedback Details:\n\nQuestion: ${feedback.user_question}\n\nResponse: ${feedback.bot_response}\n\nType: ${feedback.response_type}\n\nFeedback: ${feedback.feedback_type}\n\nTime: ${new Date(feedback.feedback_timestamp).toLocaleString()}`);
                    }
                })
                .catch(error => console.error('Error viewing feedback:', error));
        }
        
        // Chat Settings Management
        function loadChatSettings() {
            fetch('/chat_settings')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.settings) {
                        // Update UI with current settings
                        document.getElementById('typingEffectEnabled').checked = data.settings.typing_effect_enabled;
                        document.getElementById('typingEffectSpeed').value = data.settings.typing_effect_speed;
                        document.getElementById('typingSpeedValue').textContent = data.settings.typing_effect_speed + 'ms';
                        document.getElementById('autoScrollDuringTyping').checked = data.settings.auto_scroll_during_typing;
                        
                        showChatSettingsStatus('Settings loaded successfully!', 'success');
                    } else {
                        showChatSettingsStatus('Failed to load settings', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error loading chat settings:', error);
                    showChatSettingsStatus('Error loading settings', 'danger');
                });
        }
        
        function saveChatSettings() {
            const settings = {
                typing_effect_enabled: document.getElementById('typingEffectEnabled').checked,
                typing_effect_speed: parseInt(document.getElementById('typingEffectSpeed').value),
                auto_scroll_during_typing: document.getElementById('autoScrollDuringTyping').checked
            };
            
            fetch('/chat_settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showChatSettingsStatus('Settings saved successfully!', 'success');
                    } else {
                        showChatSettingsStatus('Failed to save settings: ' + (data.error || 'Unknown error'), 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error saving chat settings:', error);
                    showChatSettingsStatus('Error saving settings', 'danger');
                });
        }
        
        function showChatSettingsStatus(message, type) {
            const statusDiv = document.getElementById('chatSettingsStatus');
            statusDiv.innerHTML = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Auto-hide success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusDiv.innerHTML = '';
                }, 3000);
            }
        }
        
        // Update typing speed display when slider changes
        document.addEventListener('DOMContentLoaded', function() {
            const typingSpeedSlider = document.getElementById('typingEffectSpeed');
            const typingSpeedValue = document.getElementById('typingSpeedValue');
            
            if (typingSpeedSlider && typingSpeedValue) {
                typingSpeedSlider.addEventListener('input', function() {
                    typingSpeedValue.textContent = this.value + 'ms';
                });
            }
            
            // Load settings on page load
            loadChatSettings();
        });

        // System Logs Functions
        let autoRefreshInterval;
        
        function initializeSystemLogs() {
            loadSystemLogs();
            
            // Set up auto-refresh
            const autoRefreshCheckbox = document.getElementById('autoRefreshLogs');
            if (autoRefreshCheckbox && autoRefreshCheckbox.checked) {
                startAutoRefresh();
            }
            
            // Add event listeners for filters
            document.getElementById('logLevelFilter')?.addEventListener('change', loadSystemLogs);
            document.getElementById('responseTypeFilter')?.addEventListener('change', loadSystemLogs);
            document.getElementById('logSearchFilter')?.addEventListener('input', debounce(loadSystemLogs, 500));
            document.getElementById('autoRefreshLogs')?.addEventListener('change', function() {
                if (this.checked) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
        }
        
        function loadSystemLogs() {
            const levelFilter = document.getElementById('logLevelFilter')?.value || '';
            const responseTypeFilter = document.getElementById('responseTypeFilter')?.value || '';
            const searchQuery = document.getElementById('logSearchFilter')?.value || '';
            
            const params = new URLSearchParams({
                limit: '50',
                level: levelFilter,
                response_type: responseTypeFilter,
                search: searchQuery
            });
            
            fetch(`/logs?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayLogs(data.logs);
                    } else {
                        console.error('Error loading logs:', data.error);
                        document.getElementById('systemLogs').innerHTML = 
                            `<div class="text-danger text-center py-3">
                                <i class="fas fa-exclamation-triangle"></i> Error loading logs: ${data.error}
                            </div>`;
                    }
                })
                .catch(error => {
                    console.error('Error fetching logs:', error);
                    document.getElementById('systemLogs').innerHTML = 
                        `<div class="text-danger text-center py-3">
                            <i class="fas fa-exclamation-triangle"></i> Failed to fetch logs
                        </div>`;
                });
        }
        
        function displayLogs(logs) {
            const logsContainer = document.getElementById('systemLogs');
            
            if (!logs || logs.length === 0) {
                logsContainer.innerHTML = 
                    `<div class="text-muted text-center py-3">
                        <i class="fas fa-info-circle"></i> No logs found matching the current filters
                    </div>`;
                return;
            }
            
            const logHtml = logs.map(log => {
                const levelColor = getLevelColor(log.level);
                const responseTypeIcon = getResponseTypeIcon(log.response_type);
                
                return `
                    <div class="log-entry mb-1" style="font-size: 0.875rem;">
                        <span style="color: #888;">[${log.timestamp}]</span>
                        <span style="color: ${levelColor}; font-weight: bold;">${log.level}</span>
                        ${responseTypeIcon}
                        <span style="color: #d4d4d4;">${escapeHtml(log.message)}</span>
                    </div>
                `;
            }).join('');
            
            logsContainer.innerHTML = logHtml;
            // Auto-scroll to bottom if not manually scrolled up
            if (logsContainer.scrollTop >= logsContainer.scrollHeight - logsContainer.clientHeight - 50) {
                logsContainer.scrollTop = logsContainer.scrollHeight;
            }
        }
        
        function getLevelColor(level) {
            switch (level) {
                case 'ERROR': return '#ff6b6b';
                case 'WARNING': return '#feca57';
                case 'INFO': return '#48cae4';
                case 'DEBUG': return '#a8dadc';
                default: return '#d4d4d4';
            }
        }
        
        function getResponseTypeIcon(responseType) {
            switch (responseType) {
                case 'TEMPLATE_MATCH': return '<span style="color: #4ade80;">üéØ</span>';
                case 'SMALL_TALK': return '<span style="color: #60a5fa;">üí¨</span>';
                case 'AI_TOOL': return '<span style="color: #f59e0b;">ü§ñ</span>';
                case 'RAG_KNOWLEDGE_BASE': return '<span style="color: #8b5cf6;">üß†</span>';
                default: return '<span style="color: #6b7280;">üìã</span>';
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function refreshLogs() {
            const refreshBtn = document.querySelector('[onclick="refreshLogs()"] i');
            if (refreshBtn) {
                refreshBtn.classList.add('fa-spin');
                setTimeout(() => refreshBtn.classList.remove('fa-spin'), 1000);
            }
            loadSystemLogs();
        }
        
        function clearLogsDisplay() {
            document.getElementById('systemLogs').innerHTML = 
                `<div class="text-muted text-center py-3">
                    <i class="fas fa-info-circle"></i> Log display cleared
                </div>`;
        }
        
        function downloadLogs() {
            const levelFilter = document.getElementById('logLevelFilter')?.value || '';
            const responseTypeFilter = document.getElementById('responseTypeFilter')?.value || '';
            const searchQuery = document.getElementById('logSearchFilter')?.value || '';
            
            const params = new URLSearchParams({
                limit: '1000',
                level: levelFilter,
                response_type: responseTypeFilter,
                search: searchQuery
            });
            
            fetch(`/logs?${params.toString()}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const logText = data.logs.map(log => 
                            `[${log.timestamp}] ${log.level} ${log.message}`
                        ).join('\n');
                        
                        const blob = new Blob([logText], { type: 'text/plain' });
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `system-logs-${new Date().toISOString().slice(0, 10)}.txt`;
                        a.click();
                        window.URL.revokeObjectURL(url);
                    }
                })
                .catch(error => {
                    console.error('Error downloading logs:', error);
                    alert('Failed to download logs');
                });
        }
        
        function startAutoRefresh() {
            stopAutoRefresh(); // Clear any existing interval
            autoRefreshInterval = setInterval(loadSystemLogs, 5000); // Refresh every 5 seconds
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Live Chat Management Functions
        function loadLiveChatSessions() {
            fetch('/api/live_chat/sessions')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayLiveChatSessions(data.sessions);
                } else {
                    console.error('Error loading sessions:', data.error);
                }
            })
            .catch(error => {
                console.error('Error loading live chat sessions:', error);
            });
        }

        function displayLiveChatSessions(sessions) {
            const tbody = document.querySelector('#liveChatSessionsTable tbody');
            if (!tbody) return;
            
            if (sessions.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="7" class="text-center text-muted">No chat sessions found</td></tr>
                `;
                return;
            }

            tbody.innerHTML = sessions.map(session => `
                <tr>
                    <td><code>${session.session_id.substring(0, 8)}...</code></td>
                    <td>${session.username || session.user_identifier}</td>
                    <td><span class="badge bg-primary">${session.status}</span></td>
                    <td>${session.agent_name || 'Unassigned'}</td>
                    <td>${new Date(session.created_at).toLocaleDateString()}</td>
                    <td><span class="badge bg-secondary">${session.message_count || 0}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewSession('${session.session_id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function viewSession(sessionId) {
            window.open(`/agent_portal?session=${sessionId}`, '_blank');
        }

        // ElevenLabs Status Functions
        function checkElevenLabsStatus() {
            const statusBadge = document.getElementById('elevenlabs-status');
            const statusIcon = document.getElementById('elevenlabs-icon');
            const statusText = document.getElementById('elevenlabs-text');
            
            // Show loading state
            statusIcon.className = 'fas fa-circle text-warning';
            statusText.textContent = 'Checking...';
            statusBadge.className = 'status-badge status-warning';
            
            fetch('/api/elevenlabs/status')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        switch(data.status) {
                            case 'active':
                                statusIcon.className = 'fas fa-circle text-success';
                                statusText.textContent = data.message;
                                statusBadge.className = 'status-badge status-success';
                                break;
                            case 'no_key':
                                statusIcon.className = 'fas fa-circle text-secondary';
                                statusText.textContent = 'No API key configured';
                                statusBadge.className = 'status-badge status-warning';
                                break;
                            case 'error':
                                statusIcon.className = 'fas fa-circle text-danger';
                                statusText.textContent = data.message;
                                statusBadge.className = 'status-badge status-warning';
                                break;
                        }
                    } else {
                        statusIcon.className = 'fas fa-circle text-danger';
                        statusText.textContent = 'Check failed';
                        statusBadge.className = 'status-badge status-warning';
                    }
                })
                .catch(error => {
                    console.error('Error checking ElevenLabs status:', error);
                    statusIcon.className = 'fas fa-circle text-danger';
                    statusText.textContent = 'Connection error';
                    statusBadge.className = 'status-badge status-warning';
                });
        }

        // Check ElevenLabs status on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkElevenLabsStatus();
        });
    </script>

    <!-- Live Chat Management Section -->
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <i class="fas fa-headset"></i> Live Chat Management
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Agent Portal Link -->
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-user-tie fa-3x text-primary mb-3"></i>
                                        <h5>Agent Portal</h5>
                                        <p class="text-muted">Access the live chat agent interface</p>
                                        <a href="/agent_portal" target="_blank" class="btn btn-primary">
                                            <i class="fas fa-external-link-alt"></i> Open Agent Portal
                                        </a>
                                    </div>
                                </div>
                            </div>

                            <!-- Live Chat Sessions -->
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-comments fa-3x text-success mb-3"></i>
                                        <h5>Active Sessions</h5>
                                        <p class="text-muted">Monitor live chat sessions</p>
                                        <button class="btn btn-success" onclick="loadLiveChatSessions()">
                                            <i class="fas fa-sync-alt"></i> View Sessions
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Agent Management -->
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-users fa-3x text-info mb-3"></i>
                                        <h5>Agent Management</h5>
                                        <p class="text-muted">Manage live chat agents</p>
                                        <button class="btn btn-info" onclick="alert('Agent management coming soon!')">
                                            <i class="fas fa-cogs"></i> Manage Agents
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sessions Table -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h5><i class="fas fa-table"></i> Recent Chat Sessions</h5>
                                <div class="table-responsive">
                                    <table class="table table-striped" id="liveChatSessionsTable">
                                        <thead>
                                            <tr>
                                                <th>Session ID</th>
                                                <th>User</th>
                                                <th>Status</th>
                                                <th>Agent</th>
                                                <th>Created</th>
                                                <th>Messages</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td colspan="7" class="text-center text-muted">
                                                    <i class="fas fa-spinner fa-spin"></i> Loading sessions...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Webhook Integration Section -->
            <div class="row mb-4">
                <div class="col-12" id="webhook-integration">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-plug"></i> Webhook Integration Management</h5>
                        <p class="mb-0">Configure third-party platform integrations for external chat systems</p>
                    </div>
                    <div class="card-body">
                        <!-- Current Webhook Status -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card border-primary">
                                    <div class="card-body text-center">
                                        <i class="fas fa-toggle-on fa-3x text-success mb-3" id="webhookStatusIcon"></i>
                                        <h5>Webhook Status</h5>
                                        <div class="form-check form-switch d-flex justify-content-center">
                                            <input class="form-check-input" type="checkbox" id="webhookEnabled" onchange="toggleWebhook()">
                                            <label class="form-check-label ms-2" for="webhookEnabled" id="webhookStatusLabel">
                                                Disabled
                                            </label>
                                        </div>
                                        <small class="text-muted" id="webhookStatusDescription">
                                            When enabled, live chat messages are routed to external platforms
                                        </small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-info">
                                    <div class="card-body text-center">
                                        <i class="fas fa-link fa-3x text-info mb-3"></i>
                                        <h5>Active Configuration</h5>
                                        <p class="mb-1" id="activeWebhookName">No active webhook</p>
                                        <small class="text-muted" id="activeWebhookProvider">Configure webhook below</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Webhook Configuration Form -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <h6><i class="fas fa-cog"></i> Create New Webhook Configuration</h6>
                                <form id="webhookConfigForm" onsubmit="createWebhookConfig(event)">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="webhookName" class="form-label">Configuration Name</label>
                                                <input type="text" class="form-control" id="webhookName" required
                                                       placeholder="e.g., Freshchat Integration">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="webhookProvider" class="form-label">Platform Provider</label>
                                                <select class="form-control" id="webhookProvider" required>
                                                    <option value="">Select Provider</option>
                                                    <option value="freshchat">Freshchat</option>
                                                    <option value="zendesk">Zendesk</option>
                                                    <option value="intercom">Intercom</option>
                                                    <option value="crisp">Crisp</option>
                                                    <option value="custom">Custom Platform</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label for="webhookOutgoingUrl" class="form-label">Outgoing Webhook URL</label>
                                        <input type="url" class="form-control" id="webhookOutgoingUrl" required
                                               placeholder="https://your-platform.com/webhook/incoming">
                                        <div class="form-text">URL where we send chatbot responses to your platform</div>
                                    </div>
                                    
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label for="webhookAuthToken" class="form-label">Authentication Token</label>
                                                <input type="password" class="form-control" id="webhookAuthToken"
                                                       placeholder="Bearer token for authentication">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="webhookTimeout" class="form-label">Timeout (seconds)</label>
                                                <input type="number" class="form-control" id="webhookTimeout" 
                                                       value="30" min="5" max="120">
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="mb-3">
                                                <label for="webhookRetries" class="form-label">Retry Attempts</label>
                                                <input type="number" class="form-control" id="webhookRetries" 
                                                       value="3" min="0" max="10">
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Custom Headers (Optional)</label>
                                        <div id="customHeaders">
                                            <div class="row mb-2">
                                                <div class="col-md-5">
                                                    <input type="text" class="form-control" placeholder="Header Name" 
                                                           name="headerName[]">
                                                </div>
                                                <div class="col-md-5">
                                                    <input type="text" class="form-control" placeholder="Header Value" 
                                                           name="headerValue[]">
                                                </div>
                                                <div class="col-md-2">
                                                    <button type="button" class="btn btn-outline-primary" onclick="addCustomHeader()">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" id="setAsActive">
                                        <label class="form-check-label" for="setAsActive">
                                            Set as active configuration
                                        </label>
                                    </div>

                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> Create Webhook Configuration
                                    </button>
                                </form>
                            </div>
                        </div>

                        <!-- Existing Configurations -->
                        <div class="row">
                            <div class="col-12">
                                <h6><i class="fas fa-list"></i> Existing Webhook Configurations</h6>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Provider</th>
                                                <th>Webhook URL</th>
                                                <th>Status</th>
                                                <th>Created</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="webhookConfigsList">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">
                                                    <i class="fas fa-spinner fa-spin"></i> Loading webhook configurations...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Webhook Messages History -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <h6><i class="fas fa-history"></i> Webhook Message History</h6>
                                <div class="row mb-3">
                                    <div class="col-md-3">
                                        <select class="form-control" id="filterPlatform" onchange="loadWebhookMessages()">
                                            <option value="">All Platforms</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-control" id="filterMessageType" onchange="loadWebhookMessages()">
                                            <option value="">All Message Types</option>
                                            <option value="incoming">Incoming</option>
                                            <option value="outgoing">Outgoing</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-control" id="filterStatus" onchange="loadWebhookMessages()">
                                            <option value="">All Statuses</option>
                                            <option value="pending">Pending</option>
                                            <option value="sent">Sent</option>
                                            <option value="failed">Failed</option>
                                            <option value="received">Received</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <button class="btn btn-outline-secondary" onclick="loadWebhookMessages()">
                                            <i class="fas fa-refresh"></i> Refresh
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead>
                                            <tr>
                                                <th>Platform</th>
                                                <th>Type</th>
                                                <th>User</th>
                                                <th>Message</th>
                                                <th>Status</th>
                                                <th>Timestamp</th>
                                            </tr>
                                        </thead>
                                        <tbody id="webhookMessagesList">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted">
                                                    <i class="fas fa-spinner fa-spin"></i> Loading webhook messages...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Integration Guide -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="mb-0"><i class="fas fa-book"></i> Integration Guide</h6>
                                    </div>
                                    <div class="card-body">
                                        <h6>Incoming Webhook Endpoint:</h6>
                                        <code>POST /api/webhook/incoming</code>
                                        
                                        <h6 class="mt-3">Required Payload Format:</h6>
                                        <pre class="bg-light p-2 rounded"><code>{
  "user_id": "external_user_123",
  "username": "John Doe",
  "message": "Hello, I need help",
  "platform": "freshchat",
  "conversation_id": "conv_456",
  "timestamp": "2025-01-19T12:00:00Z"
}</code></pre>
                                        
                                        <h6 class="mt-3">Message Routing Logic:</h6>
                                        <ul>
                                            <li><strong>Webhook OFF:</strong> Messages route to live chat interface</li>
                                            <li><strong>Webhook ON:</strong> Messages process through AI/RAG and respond via external API</li>
                                            <li><strong>Live Chat Keywords:</strong> "live chat", "talk to agent", "human agent" trigger live chat transfer</li>
                                        </ul>
                                        
                                        <div class="mt-3">
                                            <a href="/static/WEBHOOK_INTEGRATION_GUIDE.md" class="btn btn-outline-info btn-sm" target="_blank">
                                                <i class="fas fa-external-link-alt"></i> Full Integration Guide
                                            </a>
                                            <button class="btn btn-outline-primary btn-sm ms-2" onclick="testWebhookIntegration()">
                                                <i class="fas fa-play"></i> Test Integration
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
            </div>

    <script>
        // Webhook Integration JavaScript Functions
        let webhookConfigs = [];

        function loadWebhookConfigs() {
            fetch('/api/webhook/config')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        webhookConfigs = data.configs;
                        updateWebhookConfigsList();
                        updateWebhookStatus();
                    }
                })
                .catch(error => console.error('Error loading webhook configs:', error));
        }

        function updateWebhookStatus() {
            const activeConfig = webhookConfigs.find(config => config.is_active);
            const statusIcon = document.getElementById('webhookStatusIcon');
            const statusLabel = document.getElementById('webhookStatusLabel');
            const statusDescription = document.getElementById('webhookStatusDescription');
            const webhookEnabled = document.getElementById('webhookEnabled');
            const activeWebhookName = document.getElementById('activeWebhookName');
            const activeWebhookProvider = document.getElementById('activeWebhookProvider');

            if (activeConfig) {
                statusIcon.className = 'fas fa-toggle-on fa-3x text-success mb-3';
                statusLabel.textContent = 'Enabled';
                statusDescription.textContent = 'Live chat messages are routed to external platform';
                webhookEnabled.checked = true;
                activeWebhookName.textContent = activeConfig.name;
                activeWebhookProvider.textContent = activeConfig.provider;
            } else {
                statusIcon.className = 'fas fa-toggle-off fa-3x text-muted mb-3';
                statusLabel.textContent = 'Disabled';
                statusDescription.textContent = 'Live chat messages stay in internal system';
                webhookEnabled.checked = false;
                activeWebhookName.textContent = 'No active webhook';
                activeWebhookProvider.textContent = 'Configure webhook below';
            }
        }

        function toggleWebhook() {
            const isEnabled = document.getElementById('webhookEnabled').checked;
            
            if (isEnabled && webhookConfigs.length === 0) {
                alert('Please create a webhook configuration first');
                document.getElementById('webhookEnabled').checked = false;
                return;
            }

            if (isEnabled) {
                // Find first available config or let user choose
                const availableConfigs = webhookConfigs.filter(config => !config.is_active);
                if (availableConfigs.length > 0) {
                    activateWebhookConfig(availableConfigs[0].id);
                }
            } else {
                // Deactivate all configs
                webhookConfigs.forEach(config => {
                    if (config.is_active) {
                        deactivateWebhookConfig(config.id);
                    }
                });
            }
        }

        function activateWebhookConfig(configId) {
            // First deactivate all configs
            fetch('/api/webhook/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'deactivate_all' })
            })
            .then(() => {
                // Then activate the selected config
                return fetch('/api/webhook/config', {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'activate', config_id: configId })
                });
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadWebhookConfigs(); // Refresh
                    showAlert('Webhook activated successfully!', 'success');
                } else {
                    showAlert('Error activating webhook: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error activating webhook:', error);
                showAlert('Error activating webhook', 'danger');
            });
        }

        function createWebhookConfig(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const headers = {};
            
            // Collect custom headers
            const headerNames = document.querySelectorAll('input[name="headerName[]"]');
            const headerValues = document.querySelectorAll('input[name="headerValue[]"]');
            
            for (let i = 0; i < headerNames.length; i++) {
                if (headerNames[i].value && headerValues[i].value) {
                    headers[headerNames[i].value] = headerValues[i].value;
                }
            }

            const configData = {
                name: document.getElementById('webhookName').value,
                provider: document.getElementById('webhookProvider').value,
                outgoing_webhook_url: document.getElementById('webhookOutgoingUrl').value,
                auth_token: document.getElementById('webhookAuthToken').value,
                timeout_seconds: parseInt(document.getElementById('webhookTimeout').value),
                retry_attempts: parseInt(document.getElementById('webhookRetries').value),
                custom_headers: headers,
                is_active: document.getElementById('setAsActive').checked
            };

            fetch('/api/webhook/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(configData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Webhook configuration created successfully!', 'success');
                    document.getElementById('webhookConfigForm').reset();
                    loadWebhookConfigs(); // Refresh the list
                } else {
                    showAlert('Error creating webhook configuration: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error creating webhook config:', error);
                showAlert('Error creating webhook configuration', 'danger');
            });
        }

        function addCustomHeader() {
            const headersContainer = document.getElementById('customHeaders');
            const newHeaderRow = document.createElement('div');
            newHeaderRow.className = 'row mb-2';
            newHeaderRow.innerHTML = `
                <div class="col-md-5">
                    <input type="text" class="form-control" placeholder="Header Name" name="headerName[]">
                </div>
                <div class="col-md-5">
                    <input type="text" class="form-control" placeholder="Header Value" name="headerValue[]">
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-outline-danger" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
            `;
            headersContainer.appendChild(newHeaderRow);
        }

        function updateWebhookConfigsList() {
            const tbody = document.getElementById('webhookConfigsList');
            if (webhookConfigs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No webhook configurations found</td></tr>';
                return;
            }

            tbody.innerHTML = webhookConfigs.map(config => `
                <tr>
                    <td>${config.name}</td>
                    <td><span class="badge bg-secondary">${config.provider}</span></td>
                    <td><small>${config.webhook_url}</small></td>
                    <td>
                        ${config.is_active ? 
                            '<span class="badge bg-success">Active</span>' : 
                            '<span class="badge bg-secondary">Inactive</span>'
                        }
                    </td>
                    <td><small>${new Date(config.created_at).toLocaleDateString()}</small></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            ${!config.is_active ? 
                                `<button class="btn btn-outline-success" onclick="activateWebhookConfig(${config.id})" title="Activate">
                                    <i class="fas fa-play"></i>
                                </button>` : 
                                `<button class="btn btn-outline-warning" onclick="deactivateWebhookConfig(${config.id})" title="Deactivate">
                                    <i class="fas fa-pause"></i>
                                </button>`
                            }
                            <button class="btn btn-outline-danger" onclick="deleteWebhookConfig(${config.id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function loadWebhookMessages() {
            const platform = document.getElementById('filterPlatform').value;
            const messageType = document.getElementById('filterMessageType').value;
            const status = document.getElementById('filterStatus').value;

            const params = new URLSearchParams();
            if (platform) params.append('platform', platform);
            if (messageType) params.append('message_type', messageType);
            if (status) params.append('status', status);
            params.append('per_page', '20');

            fetch(`/api/webhook/messages?${params}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        updateWebhookMessagesList(data.messages);
                        updatePlatformFilter(data.messages);
                    }
                })
                .catch(error => console.error('Error loading webhook messages:', error));
        }

        function updateWebhookMessagesList(messages) {
            const tbody = document.getElementById('webhookMessagesList');
            if (messages.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No webhook messages found</td></tr>';
                return;
            }

            tbody.innerHTML = messages.map(msg => `
                <tr>
                    <td><span class="badge bg-info">${msg.platform}</span></td>
                    <td>
                        <span class="badge ${msg.message_type === 'incoming' ? 'bg-primary' : 'bg-success'}">
                            ${msg.message_type}
                        </span>
                    </td>
                    <td>${msg.username || 'Unknown'}</td>
                    <td><small>${msg.message_content.substring(0, 50)}${msg.message_content.length > 50 ? '...' : ''}</small></td>
                    <td>
                        <span class="badge ${
                            msg.status === 'sent' ? 'bg-success' :
                            msg.status === 'failed' ? 'bg-danger' :
                            msg.status === 'pending' ? 'bg-warning' : 'bg-secondary'
                        }">
                            ${msg.status}
                        </span>
                    </td>
                    <td><small>${new Date(msg.timestamp).toLocaleString()}</small></td>
                </tr>
            `).join('');
        }

        function updatePlatformFilter(messages) {
            const platforms = [...new Set(messages.map(msg => msg.platform))];
            const select = document.getElementById('filterPlatform');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">All Platforms</option>';
            platforms.forEach(platform => {
                const option = document.createElement('option');
                option.value = platform;
                option.textContent = platform;
                if (platform === currentValue) option.selected = true;
                select.appendChild(option);
            });
        }

        function deactivateWebhookConfig(configId) {
            if (!confirm('Are you sure you want to deactivate this webhook configuration?')) {
                return;
            }

            fetch('/api/webhook/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'deactivate', config_id: configId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadWebhookConfigs(); // Refresh
                    showAlert('Webhook deactivated successfully!', 'success');
                } else {
                    showAlert('Error deactivating webhook: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error deactivating webhook:', error);
                showAlert('Error deactivating webhook', 'danger');
            });
        }

        function deleteWebhookConfig(configId) {
            if (!confirm('Are you sure you want to delete this webhook configuration? This action cannot be undone.')) {
                return;
            }

            fetch(`/api/webhook/config/${configId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadWebhookConfigs(); // Refresh
                    showAlert('Webhook configuration deleted successfully!', 'success');
                } else {
                    showAlert('Error deleting webhook: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error deleting webhook:', error);
                showAlert('Error deleting webhook configuration', 'danger');
            });
        }
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'deactivate_all' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Webhook deactivated successfully!', 'success');
                    loadWebhookConfigs(); // Refresh
                } else {
                    showAlert('Error deactivating webhook: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error deactivating webhook:', error);
                showAlert('Error deactivating webhook', 'danger');
            });
        }

        function deleteWebhookConfig(configId) {
            if (!confirm('Are you sure you want to delete this webhook configuration? This action cannot be undone.')) {
                return;
            }

            fetch(`/api/webhook/config/${configId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Webhook configuration deleted successfully!', 'success');
                    loadWebhookConfigs(); // Refresh
                } else {
                    showAlert('Error deleting webhook: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error deleting webhook:', error);
                showAlert('Error deleting webhook configuration', 'danger');
            });
        }

        function testWebhookIntegration() {
            const testData = {
                user_id: 'test_user_123',
                username: 'Test User',
                message: 'This is a test message from admin panel',
                platform: 'admin_test',
                conversation_id: 'test_conv_' + Date.now(),
                timestamp: new Date().toISOString()
            };

            fetch('/api/webhook/incoming', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(testData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Test webhook processed successfully! Check message history below.', 'success');
                    loadWebhookMessages(); // Refresh messages
                } else {
                    showAlert('Test webhook failed: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                console.error('Error testing webhook:', error);
                showAlert('Error testing webhook integration', 'danger');
            });
        }

        // Unified Conversations Management Functions
        let currentPage = 0;
        const pageSize = 20;
        let totalConversations = 0;
        let currentFilters = { type: 'all', user: '', date: '', search: '' };

        function refreshConversations() {
            currentPage = 0;
            loadUnifiedConversations();
        }

        function loadConversationStats() {
            fetch('/api/conversations/stats')
                .then(response => response.json())
                .then(data => {
                    const statsHtml = `
                        <div class="row text-center">
                            <div class="col-md-2">
                                <strong>${data.total_conversations}</strong><br>
                                <small>Total Conversations</small>
                            </div>
                            <div class="col-md-2">
                                <strong>${data.chatbot_conversations}</strong><br>
                                <small>Chatbot</small>
                            </div>
                            <div class="col-md-2">
                                <strong>${data.live_chat_conversations}</strong><br>
                                <small>Live Chat</small>
                            </div>
                            <div class="col-md-2">
                                <strong>${data.active_conversations_24h}</strong><br>
                                <small>Active (24h)</small>
                            </div>
                            <div class="col-md-2">
                                <strong>${data.total_messages}</strong><br>
                                <small>Total Messages</small>
                            </div>
                            <div class="col-md-2">
                                <strong>${data.unique_users}</strong><br>
                                <small>Unique Users</small>
                            </div>
                        </div>
                    `;
                    document.getElementById('conversationStats').innerHTML = statsHtml;
                    const statsRow = document.getElementById('conversationStatsRow');
                    statsRow.style.display = statsRow.style.display === 'none' ? 'block' : 'none';
                })
                .catch(error => {
                    console.error('Error loading stats:', error);
                    alert('Error loading conversation statistics');
                });
        }

        function loadUnifiedConversations() {
            const container = document.getElementById('conversationsContainer');
            container.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin fa-2x text-muted"></i><p class="mt-2 text-muted">Loading conversations...</p></div>';
            
            // Build query parameters
            const params = new URLSearchParams({
                type: currentFilters.type,
                limit: pageSize,
                offset: currentPage * pageSize
            });
            
            if (currentFilters.user) params.append('user', currentFilters.user);
            if (currentFilters.date) params.append('date', currentFilters.date);
            if (currentFilters.search) params.append('search', currentFilters.search);
            
            fetch(`/api/conversations?${params}`)
                .then(response => response.json())
                .then(data => {
                    totalConversations = data.total_count;
                    displayConversations(data.conversations || []);
                    populateUserFilter(data.conversations || []);
                    updatePagination(data.has_more);
                })
                .catch(error => {
                    console.error('Error loading conversations:', error);
                    container.innerHTML = '<div class="alert alert-danger">Error loading conversations. Please try again.</div>';
                });
        }

        function displayConversations(conversations) {
            const container = document.getElementById('conversationsContainer');
            
            if (!conversations || conversations.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4"><i class="fas fa-comment-slash fa-3x mb-3"></i><p>No conversations found.</p></div>';
                return;
            }

            let html = '';
            conversations.forEach(conv => {
                const lastActivity = new Date(conv.last_activity).toLocaleString();
                const messageCount = conv.message_count || 0;
                const conversationType = conv.conversation_type || 'chatbot';
                const typeIcon = conversationType === 'live_chat' ? 'fas fa-headset' : 'fas fa-robot';
                const typeBadge = conversationType === 'live_chat' ? 'badge bg-info' : 'badge bg-primary';
                const agentInfo = conv.agent_name ? `<br><small class="text-muted">Agent: ${conv.agent_name}</small>` : '';
                
                html += `
                    <div class="card mb-3">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <div>
                                <strong><i class="${typeIcon}"></i> ${conv.username || conv.user_identifier}</strong>
                                <span class="${typeBadge} ms-2">${conversationType.replace('_', ' ').toUpperCase()}</span>
                                <small class="text-muted d-block">(${conv.user_identifier})</small>
                                ${agentInfo}
                            </div>
                            <div class="text-end">
                                <span class="badge bg-secondary">${messageCount} messages</span>
                                <small class="text-muted d-block">${lastActivity}</small>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>Email:</strong> ${conv.email || 'N/A'}</p>
                                    <p class="mb-1"><strong>Device:</strong> ${conv.device_id || 'N/A'}</p>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><strong>First Seen:</strong> ${new Date(conv.created_at).toLocaleString()}</p>
                                    <p class="mb-1"><strong>Last Activity:</strong> ${lastActivity}</p>
                                </div>
                            </div>
                            <div class="mt-3">
                                <button class="btn btn-sm btn-outline-primary" onclick="viewConversationDetails('${conv.session_id}')">
                                    <i class="fas fa-eye"></i> View Messages
                                </button>
                                <button class="btn btn-sm btn-outline-info" onclick="exportConversation('${conv.session_id}')">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function populateUserFilter(conversations) {
            const userFilter = document.getElementById('userFilter');
            const currentValue = userFilter.value;
            
            // Clear existing options except "All Users"
            userFilter.innerHTML = '<option value="">All Users</option>';
            
            // Get unique users
            const users = [...new Set(conversations.map(conv => conv.user_identifier))];
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user;
                option.textContent = user;
                userFilter.appendChild(option);
            });
            
            // Restore previous selection
            userFilter.value = currentValue;
        }

        function updatePagination(hasMore) {
            const pagination = document.getElementById('conversationPagination');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const countText = document.getElementById('conversationCount');
            
            // Update count text
            const startCount = (currentPage * pageSize) + 1;
            const endCount = Math.min((currentPage + 1) * pageSize, totalConversations);
            countText.textContent = `Showing ${startCount}-${endCount} of ${totalConversations} conversations`;
            
            // Update buttons
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = !hasMore;
            
            // Show pagination if there are results
            pagination.style.display = totalConversations > 0 ? 'flex' : 'none';
        }

        function previousPage() {
            if (currentPage > 0) {
                currentPage--;
                loadUnifiedConversations();
            }
        }

        function nextPage() {
            currentPage++;
            loadUnifiedConversations();
        }

        function filterConversations() {
            // Update filters from form values
            currentFilters.type = document.getElementById('conversationTypeFilter').value;
            currentFilters.user = document.getElementById('userFilter').value;
            currentFilters.date = document.getElementById('dateFilter').value;
            currentFilters.search = document.getElementById('searchConversations').value;
            
            // Reset to first page and reload
            currentPage = 0;
            loadUnifiedConversations();
        }

        function searchConversations() {
            // Update search filter and reload
            currentFilters.search = document.getElementById('searchConversations').value;
            currentPage = 0;
            loadUnifiedConversations();
        }

        function viewConversationDetails(sessionId) {
            fetch(`/api/conversations/${sessionId}`)
                .then(response => response.json())
                .then(data => {
                    displayConversationModal(data.conversation, data.messages || []);
                })
                .catch(error => {
                    console.error('Error loading conversation details:', error);
                    showAlert('Error loading conversation details', 'danger');
                });
        }

        function displayConversationModal(conversation, messages) {
            const modalContent = `
                <div class="modal fade" id="conversationModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="fas fa-comments"></i> Conversation: ${conversation.username || conversation.user_identifier}
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>User ID:</strong> ${conversation.user_identifier}</p>
                                            <p><strong>Email:</strong> ${conversation.email || 'N/A'}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Device:</strong> ${conversation.device_id || 'N/A'}</p>
                                            <p><strong>Messages:</strong> ${messages.length}</p>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <div class="conversation-messages" style="max-height: 400px; overflow-y: auto;">
                                    ${messages.map(msg => `
                                        <div class="message mb-3 p-3 ${msg.type === 'human' ? 'bg-light' : 'bg-primary bg-opacity-10'} rounded">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <strong class="${msg.type === 'human' ? 'text-primary' : 'text-success'}">
                                                    ${msg.type === 'human' ? 'üë§ User' : 'ü§ñ Bot'}
                                                </strong>
                                                <small class="text-muted">${new Date().toLocaleString()}</small>
                                            </div>
                                            <div>${msg.content}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="exportConversation('${conversation.user_identifier}')">
                                    <i class="fas fa-download"></i> Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove existing modal if any
            const existingModal = document.getElementById('conversationModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add modal to body
            document.body.insertAdjacentHTML('beforeend', modalContent);
            
            // Show modal
            new bootstrap.Modal(document.getElementById('conversationModal')).show();
        }

        function exportConversation(userIdentifier) {
            fetch(`/api/conversations/${userIdentifier}/export`)
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `conversation_${userIdentifier}_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                })
                .catch(error => {
                    console.error('Error exporting conversation:', error);
                    showAlert('Error exporting conversation', 'danger');
                });
        }

        // Load webhook data when page is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-load webhook configurations and messages on page load
            setTimeout(() => {
                loadWebhookConfigs();
                loadWebhookMessages();
                loadUnifiedConversations(); // Load unified conversations
            }, 500);
        });
    </script>

</body>
</html>
